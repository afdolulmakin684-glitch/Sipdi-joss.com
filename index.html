<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Digital Mahesa Scout</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #6700A3 0%, #1B2062 50%, #050C38 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .scanner-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            min-height: 400px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
        }
        
        #qr-reader {
            width: 100% !important;
            max-width: 600px !important;
        }
        
        #qr-reader video {
            border-radius: 8px !important;
        }
        
        #qr-reader__dashboard {
            padding: 10px !important;
        }
        
        #qr-reader__camera_selection {
            margin: 10px 0 !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        
        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        * {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .smooth-transition {
            transition: all 0.2s ease-out;
        }
        
        .qr-code-cell {
            max-width: 80px;
        }
        
        .qr-code-cell canvas {
            max-width: 60px;
            height: auto;
        }

        .report-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- ========================================
         LOGIN PAGE
         ======================================== -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üèïÔ∏è</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h1>
                <p class="text-gray-600">Sistem Absensi Digital Mahesa Scout</p>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                           placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                           placeholder="Masukkan password">
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="ml-2 text-sm text-gray-600">Ingat saya</span>
                    </label>
                    <button type="button" onclick="showResetModal()" 
                            class="text-sm text-purple-600 hover:text-purple-800">
                        Lupa password?
                    </button>
                </div>
                
                <button type="submit" 
                        class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition duration-200 font-medium">
                    Masuk ke Dashboard
                </button>
            </form>
            
            <!-- Footer -->
            <div class="text-center mt-8 text-sm text-gray-500">
                ¬© 2024 Mahesa Scout Digital Attendance System
            </div>
        </div>
    </div>

    <!-- ========================================
         DASHBOARD MAIN CONTAINER
         ======================================== -->
    <div id="dashboard" class="hidden min-h-screen bg-gray-50">
        
        <!-- ========================================
             HEADER SECTION
             ======================================== -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo & Title -->
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üèïÔ∏è</span>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Mahesa Scout</h1>
                            <p class="text-sm text-gray-500">Sistem Absensi Digital</p>
                        </div>
                    </div>
                    
                    <!-- Header Actions -->
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="currentDateTime"></span>
                        <button onclick="showAdminPanel()" 
                                class="admin-only flex items-center px-3 py-2 text-gray-700 hover:text-purple-600 transition">
                            <span class="mr-2">‚öôÔ∏è</span>
                            Admin
                        </button>
                        <button onclick="logout()" 
                                class="flex items-center px-3 py-2 text-gray-700 hover:text-red-600 transition">
                            <span class="mr-2">üö™</span>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ========================================
             NAVIGATION TABS
             ======================================== -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('dashboard', event)" 
                            class="tab-btn active px-3 py-4 text-sm font-medium border-b-2 border-purple-500 text-purple-600">
                        <span class="mr-2">üìä</span>Dashboard
                    </button>
                    <button onclick="showTab('scanner', event)" 
                            class="tab-btn px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <span class="mr-2">üì±</span>Scan QR
                    </button>
                    <button onclick="showTab('members', event)" 
                            class="admin-only tab-btn px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <span class="mr-2">üë•</span>Anggota
                    </button>
                    <button onclick="showTab('attendance', event)" 
                            class="admin-only tab-btn px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <span class="mr-2">üìã</span>Presensi
                    </button>
                </div>
            </div>
        </nav>

        <!-- ========================================
             DASHBOARD TAB CONTENT
             ======================================== -->
        <div id="dashboardTab" class="tab-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <!-- Total Members Card -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üë•</div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Anggota</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalMembers">59</p>
                        </div>
                    </div>
                </div>
                
                <!-- Check In Card -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üåÖ</div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Absen Masuk</p>
                            <p class="text-2xl font-bold text-green-600" id="checkedIn">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Check Out Card -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üåÜ</div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Absen Pulang</p>
                            <p class="text-2xl font-bold text-blue-600" id="checkedOut">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Not Checked Out Card -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">‚è∞</div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Belum Pulang</p>
                            <p class="text-2xl font-bold text-orange-600" id="notCheckedOut">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Percentage Card -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìä</div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Persentase</p>
                            <p class="text-2xl font-bold text-purple-600" id="attendancePercentage">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                <div id="recentActivity" class="text-gray-500">
                    Belum ada aktivitas presensi hari ini
                </div>
            </div>
        </div>

        <!-- ========================================
             SCANNER TAB CONTENT
             ======================================== -->
        <div id="scannerTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Scan QR Code untuk Absensi</h3>
                
                <!-- Scanner Controls -->
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">üì±</div>
                    <p class="text-gray-600 mb-4">Klik "Mulai Scan" untuk mengaktifkan kamera</p>
                    
                    <!-- Control Buttons -->
                    <div class="space-x-4">
                        <button id="startScanBtn" onclick="startScanning()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <span class="mr-2">üì±</span>Mulai Scan
                        </button>
                        <button id="stopScanBtn" onclick="stopScanning()" 
                                class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition hidden">
                            <span class="mr-2">‚èπÔ∏è</span>Berhenti Scan
                        </button>
                        <button onclick="showBrowserPermissionGuide('PERMISSION_DENIED')" 
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                            <span class="mr-2">üîí</span>Cara Izin Kamera
                        </button>
                        <button onclick="testCamera()" 
                                class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition text-sm">
                            <span class="mr-2">üì∑</span>Test Kamera
                        </button>
                        <button onclick="testAudio()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                            <span class="mr-2">üîä</span>Test Audio
                        </button>
                    </div>
                </div>
                
                <!-- QR Reader Container -->
                <div id="qr-reader" class="scanner-container mx-auto max-w-4xl mb-6"></div>
                
                <!-- Scanner Status -->
                <div id="scanStatus" class="hidden text-center mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                    <span class="text-green-800">Scanner aktif - Arahkan kamera ke QR Code</span>
                </div>
                
                <!-- Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        <span class="mr-2">üí°</span>
                        <strong>Petunjuk:</strong> Arahkan kamera ke QR Code yang berisi NTA anggota. 
                        Sistem akan otomatis mendeteksi dan merekap presensi. 
                        Scan pertama = Absen Masuk, Scan kedua = Absen Pulang.
                    </p>
                </div>
                
                <!-- Member Welcome Message -->
                <div class="member-only bg-green-50 border border-green-200 rounded-lg p-4 mt-4" style="display: none;">
                    <p class="text-sm text-green-800">
                        <span class="mr-2">üëã</span>
                        <strong>Selamat datang, Anggota!</strong> 
                        Gunakan scanner ini untuk melakukan absensi. 
                        Pastikan QR Code Anda terlihat jelas di kamera.
                    </p>
                </div>
            </div>
        </div>

        <!-- ========================================
             MEMBERS TAB CONTENT
             ======================================== -->
        <div id="membersTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg card-shadow">
                
                <!-- Header Section -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Daftar Anggota Mahesa Scout</h3>
                        
                        <!-- Action Buttons -->
                        <div class="admin-only space-x-2">
                            <button onclick="showMemberManagement()" 
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                                <span class="mr-2">‚úèÔ∏è</span>Edit Data/Status Anggota
                            </button>
                            <button onclick="generateAllQR()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                <span class="mr-2">üîÑ</span>Generate Semua QR
                            </button>
                            <button onclick="forceRegenerateQR()" 
                                    class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition text-sm">
                                <span class="mr-2">‚ö°</span>Force Regenerate
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Members Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NTA</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR Code</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========================================
             ATTENDANCE TAB CONTENT
             ======================================== -->
        <div id="attendanceTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg card-shadow">
                
                <!-- Header Section -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Data Presensi</h3>
                        
                        <!-- Action Buttons -->
                        <div class="admin-only space-x-2">
                            <button onclick="exportExcel()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                <span class="mr-2">üìä</span>Export Excel
                            </button>
                            <button onclick="sendMassWhatsApp()" 
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm">
                                <span class="mr-2">üì±</span>WhatsApp Massal
                            </button>
                            <button onclick="sendWhatsApp()" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm">
                                <span class="mr-2">üìã</span>Laporan WhatsApp
                            </button>
                            <button onclick="sendAdminWhatsApp()" 
                                    class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition text-sm">
                                <span class="mr-2">üë®‚Äçüíº</span>WhatsApp Admin
                            </button>
                            <button onclick="resetData()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm">
                                <span class="mr-2">üîÑ</span>Reset Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NTA</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL COMPONENTS
         ======================================== -->

    <!-- Reset Password Modal -->
    <div id="resetModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Reset Password</h3>
                <button onclick="closeResetModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Masukkan username untuk reset password:
                </label>
                <input type="text" id="resetUsername" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex space-x-3">
                <button onclick="closeResetModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">
                    Batal
                </button>
                <button onclick="resetPassword()" 
                        class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">
                    Reset Password
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-lg font-semibold mb-4">Presensi Berhasil!</h3>
            <div id="successMessage" class="text-gray-600 mb-4"></div>
            <button onclick="closeSuccessModal()" 
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                OK
            </button>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‚öôÔ∏è Panel Admin</h3>
                <button onclick="closeAdminModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="space-y-3">
                <button onclick="showManualAttendance()" 
                        class="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition">
                    <span class="mr-3">üìù</span>Absensi Manual
                </button>
                <button onclick="showFullReport()" 
                        class="w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg transition">
                    <span class="mr-3">üìä</span>Laporan Lengkap
                </button>
                <button onclick="showMemberManagement()" 
                        class="w-full text-left px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition">
                    <span class="mr-3">‚úèÔ∏è</span>Edit Data/Status Anggota
                </button>
                <button onclick="showSystemSettings()" 
                        class="w-full text-left px-4 py-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition">
                    <span class="mr-3">‚öôÔ∏è</span>Pengaturan Sistem
                </button>
            </div>
        </div>
    </div>

    <!-- Member Management Modal -->
    <div id="memberManagementModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-6xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üë• Kelola Data Anggota</h3>
                <button onclick="closeMemberManagementModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            
            <div class="mb-4 flex justify-between items-center">
                <div class="flex space-x-2">
                    <button onclick="showAddMemberForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                        <span class="mr-2">‚ûï</span>Tambah Anggota Baru
                    </button>
                    <button onclick="saveAllChanges()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                        <span class="mr-2">üíæ</span>Simpan Semua Perubahan
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    Total: <span id="totalMembersCount">${members.length}</span> anggota
                </div>
            </div>

            <!-- Add New Member Form (Initially Hidden) -->
            <div id="addNewMemberForm" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 class="font-semibold mb-3 text-green-800">‚ûï Tambah Anggota Baru</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" id="newMemberName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NTA *</label>
                        <input type="text" id="newMemberNTA" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan *</label>
                        <select id="newMemberPosition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            <option value="">Pilih Jabatan</option>
                            <option value="KDA">KDA</option>
                            <option value="Pemangku Adat">Pemangku Adat</option>
                            <option value="Kerani I">Kerani I</option>
                            <option value="Kerani II">Kerani II</option>
                            <option value="Kerani III">Kerani III</option>
                            <option value="Bangkir I">Bangkir I</option>
                            <option value="Bangkir II">Bangkir II</option>
                            <option value="Bangkir III">Bangkir III</option>
                            <option value="Keilmuan I">Keilmuan I</option>
                            <option value="Keilmuan II">Keilmuan II</option>
                            <option value="Keilmuan III">Keilmuan III</option>
                            <option value="Sarpras I">Sarpras I</option>
                            <option value="Sarpras II">Sarpras II</option>
                            <option value="Sarpras III">Sarpras III</option>
                            <option value="Humas">Humas</option>
                            <option value="Humas & IT">Humas & IT</option>
                            <option value="KWU I">KWU I</option>
                            <option value="KWU II">KWU II</option>
                            <option value="KWU III">KWU III</option>
                            <option value="Warga">Warga</option>
                            <option value="Tamu">Tamu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                        <input type="tel" id="newMemberPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="newMemberStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="Aktif">Aktif</option>
                            <option value="Tidak Aktif">Tidak Aktif</option>
                            <option value="Alumni">Alumni</option>
                            <option value="Cuti">Cuti</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="addNewMemberFromForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition mr-2">
                            Tambah
                        </button>
                        <button onclick="cancelAddMember()" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Members Table -->
            <div class="overflow-x-auto max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NTA</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telepon</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="editableMembersTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 text-center space-x-2">
                <button onclick="saveAllChanges()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    <span class="mr-2">üíæ</span>Simpan Semua Perubahan
                </button>
                <button onclick="closeMemberManagementModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Attendance Modal -->
    <div id="manualAttendanceModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìù Absensi Manual</h3>
                <button onclick="closeManualAttendanceModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <p class="text-gray-600 mb-4">Pilih anggota untuk melakukan absensi manual</p>
            
            <div class="mb-4 space-x-2">
                <button onclick="markAllPresent()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                    <span class="mr-2">‚úÖ</span>Hadirkan Semua
                </button>
                <button onclick="markAllAbsent()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm">
                    <span class="mr-2">‚ùå</span>Batalkan Semua
                </button>
            </div>
            
            <div id="manualAttendanceList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Manual attendance list will be populated here -->
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeManualAttendanceModal()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Full Report Modal -->
    <div id="fullReportModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìä Laporan Lengkap</h3>
                <button onclick="closeFullReportModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            
            <div class="mb-4 flex space-x-2">
                <input type="date" id="reportStartDate" class="px-3 py-2 border border-gray-300 rounded-lg">
                <input type="date" id="reportEndDate" class="px-3 py-2 border border-gray-300 rounded-lg">
                <button onclick="generateReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    Generate Laporan
                </button>
            </div>
            
            <div id="reportContent" class="report-container">
                <!-- Report content will be populated here -->
            </div>
            
            <div class="mt-6 text-center space-x-2">
                <button onclick="exportReportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <span class="mr-2">üìä</span>Export Excel
                </button>
                <button onclick="printReport()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <span class="mr-2">üñ®Ô∏è</span>Print
                </button>
                <button onclick="closeFullReportModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- System Settings Modal -->
    <div id="systemSettingsModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‚öôÔ∏è Pengaturan Sistem</h3>
                <button onclick="closeSystemSettingsModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            
            <div class="settings-grid">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">üïê Jam Kerja & Absensi</h4>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-sm text-gray-600">Jam Masuk Standar:</label>
                            <input type="time" id="workStartTime" value="08:00" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Jam Pulang Standar:</label>
                            <input type="time" id="workEndTime" value="17:00" class="w-full px-2 py-1 border rounded">
                        </div>
                        <hr class="my-2">
                        <div>
                            <label class="block text-sm text-gray-600">Batas Awal Absen Masuk:</label>
                            <input type="time" id="checkInStartTime" value="06:00" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Batas Akhir Absen Masuk:</label>
                            <input type="time" id="checkInEndTime" value="12:00" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Batas Awal Absen Pulang:</label>
                            <input type="time" id="checkOutStartTime" value="15:00" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Batas Akhir Absen Pulang:</label>
                            <input type="time" id="checkOutEndTime" value="23:59" class="w-full px-2 py-1 border rounded">
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">üì± Notifikasi WhatsApp</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="enableNotifications" checked class="mr-2">
                            <span class="text-sm">Aktifkan Notifikasi</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="enableWhatsApp" checked class="mr-2">
                            <span class="text-sm">Auto WhatsApp ke Anggota</span>
                        </label>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Nomor Admin WhatsApp:</label>
                            <input type="tel" id="adminWhatsApp" placeholder="081234567890" class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">üîê Keamanan</h4>
                    <div class="space-y-2">
                        <button onclick="changePassword()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition text-sm">
                            Ubah Password
                        </button>
                        <button onclick="backupData()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition text-sm">
                            Backup Data
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">üìä Data</h4>
                    <div class="space-y-2">
                        <button onclick="importData()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition text-sm">
                            Import Data
                        </button>
                        <button onclick="exportAllData()" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700 transition text-sm">
                            Export Semua Data
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center space-x-2">
                <button onclick="saveSettings()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    Simpan Pengaturan
                </button>
                <button onclick="closeSystemSettingsModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‚úèÔ∏è Edit Presensi</h3>
                <button onclick="closeEditAttendanceModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <form id="editAttendanceForm" class="space-y-4">
                <input type="hidden" id="editAttendanceId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <input type="text" id="editAttendanceName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="editAttendanceStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="A">Absen Masuk</option>
                        <option value=".">Hadir</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jam Masuk</label>
                    <input type="time" id="editCheckInTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jam Pulang</label>
                    <input type="time" id="editCheckOutTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeEditAttendanceModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Member Modal (Legacy Support) -->
    <div id="addMemberModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="memberModalTitle" class="text-lg font-semibold">üë• Tambah Anggota</h3>
                <button onclick="closeAddMemberModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <form id="addMemberForm" class="space-y-4">
                <input type="hidden" id="editMemberId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                    <input type="text" id="memberName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NTA *</label>
                    <input type="text" id="memberNTA" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan *</label>
                    <select id="memberPosition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Pilih Jabatan</option>
                        <option value="KDA">KDA</option>
                        <option value="Pemangku Adat">Pemangku Adat</option>
                        <option value="Kerani I">Kerani I</option>
                        <option value="Kerani II">Kerani II</option>
                        <option value="Kerani III">Kerani III</option>
                        <option value="Bangkir I">Bangkir I</option>
                        <option value="Bangkir II">Bangkir II</option>
                        <option value="Bangkir III">Bangkir III</option>
                        <option value="Keilmuan I">Keilmuan I</option>
                        <option value="Keilmuan II">Keilmuan II</option>
                        <option value="Keilmuan III">Keilmuan III</option>
                        <option value="Sarpras I">Sarpras I</option>
                        <option value="Sarpras II">Sarpras II</option>
                        <option value="Sarpras III">Sarpras III</option>
                        <option value="Humas">Humas</option>
                        <option value="Humas & IT">Humas & IT</option>
                        <option value="KWU I">KWU I</option>
                        <option value="KWU II">KWU II</option>
                        <option value="KWU III">KWU III</option>
                        <option value="Warga">Warga</option>
                        <option value="Tamu">Tamu</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                    <input type="tel" id="memberPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="memberStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="Aktif">Aktif</option>
                        <option value="Tidak Aktif">Tidak Aktif</option>
                        <option value="Alumni">Alumni</option>
                        <option value="Cuti">Cuti</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeAddMemberModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mass WhatsApp Modal -->
    <div id="massWhatsAppModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üì± Kirim WhatsApp Massal</h3>
                <button onclick="closeMassWhatsAppModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            
            <div class="mb-6">
                <div class="flex space-x-4 mb-4">
                    <button onclick="selectAllMembers()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                        <span class="mr-2">‚úÖ</span>Pilih Semua
                    </button>
                    <button onclick="selectPresentMembers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                        <span class="mr-2">üë•</span>Yang Hadir Hari Ini
                    </button>
                    <button onclick="selectAbsentMembers()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition text-sm">
                        <span class="mr-2">‚ùå</span>Yang Belum Hadir
                    </button>
                    <button onclick="clearSelection()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm">
                        <span class="mr-2">üîÑ</span>Bersihkan
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Pesan:</label>
                    <select id="messageTemplate" onchange="updateMessageTemplate()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 mb-2">
                        <option value="reminder">Pengingat Absensi</option>
                        <option value="thanks">Terima Kasih Kehadiran</option>
                        <option value="absent">Pemberitahuan Tidak Hadir</option>
                        <option value="custom">Pesan Kustom</option>
                    </select>
                    <textarea id="messageContent" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Tulis pesan Anda di sini..."></textarea>
                    <p class="text-sm text-gray-500 mt-1">
                        Gunakan {nama}, {nim}, {jabatan} untuk personalisasi pesan
                    </p>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Pilih Penerima (<span id="selectedCount">0</span> dipilih):</h4>
                <div id="memberSelectionList" class="max-h-64 overflow-y-auto border rounded-lg p-2 space-y-1">
                    <!-- Member selection list will be populated here -->
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="selectedMembersInfo">Belum ada yang dipilih</span>
                </div>
                <div class="space-x-2">
                    <button onclick="sendSelectedWhatsApp()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                        <span class="mr-2">üì±</span>Kirim WhatsApp
                    </button>
                    <button onclick="closeMassWhatsAppModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT APPLICATION
         ======================================== -->
    <script>
        // ========================================
        // GLOBAL VARIABLES & STATE
        // ========================================
        
        // Authentication state
        let isLoggedIn = false;
        let userRole = null;
        let currentUser = null;
        let html5QrCode = null;
        let currentSelectedMember = null;
        let editingMemberId = null;

        // System settings
        let systemSettings = {
            workStartTime: '08:00',
            workEndTime: '17:00',
            enableNotifications: true,
            enableWhatsApp: true,
            adminWhatsApp: '6285156778899', // Default admin WhatsApp number
            checkInStartTime: '06:00',
            checkInEndTime: '12:00',
            checkOutStartTime: '15:00',
            checkOutEndTime: '23:59'
        };

        // Real Mahesa Scout members data
        const members = [
            { id: 1, name: "Muh. Agung Purnomo", nim: "21135003", position: "KDA", phone: "081234567890", status: "Aktif", qrCode: "" },
            { id: 2, name: "Meila Puji Lestari", nim: "21136002", position: "KDA", phone: "081234567891", status: "Aktif", qrCode: "" },
            { id: 3, name: "Moh. Alfa Reza", nim: "21135002", position: "Pemangku Adat", phone: "081234567892", status: "Aktif", qrCode: "" },
            { id: 4, name: "Roaita Mahya Mushoffa", nim: "21136003", position: "Pemangku Adat", phone: "081234567893", status: "Aktif", qrCode: "" },
            { id: 5, name: "Farhan Firdaus Hakiki", nim: "21135004", position: "Kerani I", phone: "081234567894", status: "Aktif", qrCode: "" },
            { id: 6, name: "Siti Aisyah Arfany", nim: "21136004", position: "Kerani II", phone: "081234567895", status: "Aktif", qrCode: "" },
            { id: 7, name: "Hilma Barika Dhuhaya", nim: "21136001", position: "Kerani III", phone: "081234567896", status: "Aktif", qrCode: "" },
            { id: 8, name: "Indra Dwi Kurniawan", nim: "21135005", position: "Bangkir I", phone: "081234567897", status: "Aktif", qrCode: "" },
            { id: 9, name: "Angel Aura Rahmadani", nim: "21136005", position: "Bangkir II", phone: "081234567898", status: "Aktif", qrCode: "" },
            { id: 10, name: "Mila Citra Oktavia", nim: "21136006", position: "Bangkir III", phone: "081234567899", status: "Aktif", qrCode: "" },
            { id: 11, name: "Uswatun Hasanah", nim: "21136007", position: "Keilmuan I", phone: "081234567800", status: "Aktif", qrCode: "" },
            { id: 12, name: "Andini Dwiyanti", nim: "21136008", position: "Keilmuan II", phone: "081234567801", status: "Aktif", qrCode: "" },
            { id: 13, name: "Vihan Thoifatun novera Dita", nim: "21136009", position: "Keilmuan III", phone: "081234567802", status: "Aktif", qrCode: "" },
            { id: 14, name: "Safinatul Mudafamah", nim: "21136010", position: "Sarpras I", phone: "081234567803", status: "Aktif", qrCode: "" },
            { id: 15, name: "Novita Anggraeni", nim: "21136011", position: "Sarpras II", phone: "081234567804", status: "Aktif", qrCode: "" },
            { id: 16, name: "Suhaeifa Heriyantika", nim: "21136012", position: "Sarpras III", phone: "081234567805", status: "Aktif", qrCode: "" },
            { id: 17, name: "Moh. Afdolul Makin", nim: "21135001", position: "Humas & IT", phone: "081234567806", status: "Aktif", qrCode: "" },
            { id: 18, name: "Naila Azzura Rahmawati", nim: "21136013", position: "Humas", phone: "081234567807", status: "Aktif", qrCode: "" },
            { id: 19, name: "Silvy Rahma Widiyanti", nim: "21136014", position: "Humas & IT", phone: "081234567808", status: "Aktif", qrCode: "" },
            { id: 20, name: "Sera Dwi Yanti", nim: "21136015", position: "Humas", phone: "081234567809", status: "Aktif", qrCode: "" },
            { id: 21, name: "Sofiyah", nim: "21136016", position: "KWU I", phone: "081234567810", status: "Aktif", qrCode: "" },
            { id: 22, name: "Najwa Rizna Maulidia", nim: "21136017", position: "KWU II", phone: "081234567811", status: "Aktif", qrCode: "" },
            { id: 23, name: "Mafaza Naila F.R", nim: "21136018", position: "KWU III", phone: "081234567812", status: "Aktif", qrCode: "" },
            { id: 24, name: "Denita Putri Ayu Wulandari", nim: "21136019", position: "Warga", phone: "081234567813", status: "Aktif", qrCode: "" },
            { id: 25, name: "Nisa Khoirina Istiqomah", nim: "21136020", position: "Warga", phone: "081234567814", status: "Aktif", qrCode: "" },
            { id: 26, name: "Muh. Alfin Rohmatullah", nim: "21135006", position: "Warga", phone: "081234567815", status: "Aktif", qrCode: "" },
            { id: 27, name: "Masy'aril Harom", nim: "21135007", position: "Warga", phone: "081234567816", status: "Aktif", qrCode: "" },
            { id: 28, name: "Nadyvatul Islamyyah", nim: "21136021", position: "Warga", phone: "081234567817", status: "Aktif", qrCode: "" },
            { id: 29, name: "Muhammad Firdaus", nim: "21135008", position: "Warga", phone: "081234567818", status: "Aktif", qrCode: "" },
            { id: 30, name: "Intan Ayu Agustin", nim: "21136022", position: "Warga", phone: "081234567819", status: "Aktif", qrCode: "" },
            { id: 31, name: "Nurul Huda Thoriqul Farizy", nim: "21135009", position: "Warga", phone: "081234567820", status: "Aktif", qrCode: "" },
            { id: 32, name: "Mohammad Alfan Nasrullah", nim: "21135010", position: "Tamu", phone: "081234567821", status: "Aktif", qrCode: "" },
            { id: 33, name: "M. Raffi Nahlah", nim: "21135011", position: "Tamu", phone: "081234567822", status: "Aktif", qrCode: "" },
            { id: 34, name: "Ulfatul Ilmia", nim: "21136023", position: "Tamu", phone: "081234567823", status: "Aktif", qrCode: "" },
            { id: 35, name: "Ahmad Bayu Hadi Firmansyah", nim: "21135012", position: "Tamu", phone: "081234567824", status: "Aktif", qrCode: "" },
            { id: 36, name: "Anis Faizzah", nim: "21136024", position: "Tamu", phone: "081234567825", status: "Aktif", qrCode: "" },
            { id: 37, name: "Fatihatul Aulia", nim: "21136025", position: "Tamu", phone: "081234567826", status: "Aktif", qrCode: "" },
            { id: 38, name: "Inneke Alya Kamalin", nim: "21136026", position: "Tamu", phone: "081234567827", status: "Aktif", qrCode: "" },
            { id: 39, name: "Kamilatul Aliyah", nim: "21136027", position: "Tamu", phone: "081234567828", status: "Aktif", qrCode: "" },
            { id: 40, name: "Nazwa Salsabila", nim: "21136028", position: "Tamu", phone: "081234567829", status: "Aktif", qrCode: "" },
            { id: 41, name: "Muhammad Andi Putra", nim: "21135013", position: "Tamu", phone: "081234567830", status: "Aktif", qrCode: "" },
            { id: 42, name: "Sifa Wardatus Sholeha", nim: "21136029", position: "Tamu", phone: "081234567831", status: "Aktif", qrCode: "" },
            { id: 43, name: "Zahra Aqila Miraya", nim: "21136030", position: "Tamu", phone: "081234567832", status: "Aktif", qrCode: "" },
            { id: 44, name: "Annisa Zuyyina R.", nim: "21136031", position: "Tamu", phone: "081234567833", status: "Aktif", qrCode: "" },
            { id: 45, name: "Irdinatul Kistina", nim: "21136032", position: "Tamu", phone: "081234567834", status: "Aktif", qrCode: "" },
            { id: 46, name: "Mohammad Rehan Dede Efendi", nim: "21135014", position: "Tamu", phone: "081234567835", status: "Aktif", qrCode: "" },
            { id: 47, name: "Nurul Layli Safitri", nim: "21136033", position: "Tamu", phone: "081234567836", status: "Aktif", qrCode: "" },
            { id: 48, name: "Aini Izzatul Wafiyah", nim: "21136034", position: "Tamu", phone: "081234567837", status: "Aktif", qrCode: "" },
            { id: 49, name: "Innes Faris Abel", nim: "21136035", position: "Tamu", phone: "081234567838", status: "Aktif", qrCode: "" },
            { id: 50, name: "M. Ulil Amirul Mukmin", nim: "21135015", position: "Tamu", phone: "081234567839", status: "Aktif", qrCode: "" },
            { id: 51, name: "Moch. Didin Maulana", nim: "21135016", position: "Tamu", phone: "081234567840", status: "Aktif", qrCode: "" },
            { id: 52, name: "Muhammad Reza", nim: "21135017", position: "Tamu", phone: "081234567841", status: "Aktif", qrCode: "" },
            { id: 53, name: "Nurma Halizah", nim: "21136036", position: "Tamu", phone: "081234567842", status: "Aktif", qrCode: "" },
            { id: 54, name: "Rizky Dwi Pranata", nim: "21135018", position: "Tamu", phone: "081234567843", status: "Aktif", qrCode: "" },
            { id: 55, name: "Nafa Izzatul Khumairo", nim: "21136037", position: "Tamu", phone: "081234567844", status: "Aktif", qrCode: "" },
            { id: 56, name: "Rajesh Primadian Radilah Akbar", nim: "21135019", position: "Tamu", phone: "081234567845", status: "Aktif", qrCode: "" },
            { id: 57, name: "Ariel Al-bir Pratama", nim: "21135020", position: "Tamu", phone: "081234567846", status: "Aktif", qrCode: "" },
            { id: 58, name: "Intan Nur Aini", nim: "21136038", position: "Tamu", phone: "081234567847", status: "Aktif", qrCode: "" },
            { id: 59, name: "Nur Laili", nim: "21136039", position: "Tamu", phone: "081234567848", status: "Aktif", qrCode: "" },
            { id: 60, name: "Sirajul Millah Wadhin Ramadhani", nim: "21135021", position: "Tamu", phone: ".", status: "Aktif", qrCode: "" },
            { id: 61, name: "Feni Nabila", nim: "21136040", position: "Tamu", phone: ".", status: "Aktif", qrCode: "" }.
        ];

        // Attendance data
        let attendanceData = [];

        // Initialize recent activity with clean state
        function initializeRecentActivity() {
            const recentActivityDiv = document.getElementById('recentActivity');
            if (attendanceData.length === 0) {
                recentActivityDiv.innerHTML = '<div class="text-gray-500 text-center py-4">Belum ada aktivitas presensi hari ini</div>';
            } else {
                // Show recent attendance if any exists
                const recentAttendance = attendanceData.slice(-3).reverse();
                recentActivityDiv.innerHTML = '';
                recentAttendance.forEach(attendance => {
                    const statusText = attendance.status === '.' ? 'Hadir Lengkap' : 'Absen Masuk';
                    addRecentActivity(`${attendance.name} - ${statusText} (${attendance.checkIn})`);
                });
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Update current date time
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Set default dates for report
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('reportStartDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];

            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Admin login
                if (username === 'admin' && password === 'mahesajoss') {
                    login('admin');
                } else {
                    // Member login - check if username matches member name and password matches NTA
                    const member = members.find(m => 
                        m.name.toLowerCase() === username.toLowerCase() && 
                        m.nim === password
                    );
                    
                    if (member) {
                        login('member', member);
                    } else {
                        alert('Username atau password salah!');
                    }
                }
            });

            // Add member form handler
            const addMemberForm = document.getElementById('addMemberForm');
            if (addMemberForm) {
                addMemberForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (editingMemberId) {
                        updateMember();
                    } else {
                        addNewMember();
                    }
                });
            }

            // Edit attendance form handler
            document.getElementById('editAttendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateAttendance();
            });

            // Generate QR codes for all members
            generateAllQR();
            
            // Initialize with clean data - no test data
            updateDashboard();
            renderMembersTable();
            renderAttendanceTable();
            initializeRecentActivity();
        });

        // Update date time display
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Authentication functions
        function login(role, user = null) {
            isLoggedIn = true;
            userRole = role;
            currentUser = user;
            
            // Initialize audio context on login (user interaction)
            initAudioContext();
            
            // Play login success sound
            setTimeout(() => {
                playLoginSound();
            }, 100);
            
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Show/hide admin features based on role
            if (role === 'member') {
                // Hide admin-only elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                // Show member-only elements
                document.querySelectorAll('.member-only').forEach(el => {
                    el.style.display = 'block';
                });
                // Update header to show member name
                document.querySelector('header h1').textContent = `Selamat Datang, ${user.name}`;
            } else {
                // Show admin elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
                // Hide member-only elements
                document.querySelectorAll('.member-only').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            // Force show dashboard tab and make it active
            setTimeout(() => {
                // Hide all tabs first
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // Remove active class from all buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'border-purple-500', 'text-purple-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Show dashboard tab
                document.getElementById('dashboardTab').classList.remove('hidden');
                
                // Make dashboard button active
                const dashboardBtn = document.querySelector('[onclick="showTab(\'dashboard\')"]');
                if (dashboardBtn) {
                    dashboardBtn.classList.add('active', 'border-purple-500', 'text-purple-600');
                    dashboardBtn.classList.remove('border-transparent', 'text-gray-500');
                }
                
                updateDashboard();
            }, 50);
        }

        function logout() {
            isLoggedIn = false;
            userRole = null;
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            // Reset header
            document.querySelector('header h1').textContent = 'Mahesa Scout';
            stopScanning();
        }

        // Tab navigation
        function showTab(tabName, event = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-purple-500', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Add active class to clicked button
            let clickedButton = null;
            if (event && event.target) {
                clickedButton = event.target;
            } else {
                // Find button by onclick attribute or data attribute
                clickedButton = document.querySelector(`[onclick*="showTab('${tabName}')"]`) || 
                               document.querySelector(`[onclick*='showTab("${tabName}")']`);
            }
            
            if (clickedButton) {
                clickedButton.classList.add('active', 'border-purple-500', 'text-purple-600');
                clickedButton.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        // QR Code generation
        async function generateQRCode(text) {
            try {
                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, text, {
                    width: 60,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                return canvas;
            } catch (error) {
                console.error('Error generating QR code:', error);
                return null;
            }
        }

        async function generateAllQR() {
            for (let member of members) {
                if (!member.qrCode) {
                    const canvas = await generateQRCode(member.nim);
                    if (canvas) {
                        member.qrCode = canvas.toDataURL();
                    }
                }
            }
            renderMembersTable();
        }

        async function forceRegenerateQR() {
            for (let member of members) {
                const canvas = await generateQRCode(member.nim);
                if (canvas) {
                    member.qrCode = canvas.toDataURL();
                }
            }
            renderMembersTable();
            alert('Semua QR Code berhasil di-regenerate!');
        }

        // QR Scanner functions
        let isScanning = false;
        let currentCamera = 'user'; // Always use front camera
        let scanCooldown = false;

        async function startScanning() {
            try {
                // Initialize audio context when user starts scanning (user interaction)
                initAudioContext();
                
                // Check if browser supports camera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showBrowserPermissionGuide('BROWSER_NOT_SUPPORTED');
                    return;
                }
                
                console.log('üîç Memulai proses akses kamera...');
                showTemporaryMessage('üîç Meminta izin kamera...');
                
                // Show permission guide first
                showPermissionGuide();
                
                // Step 1: Request basic camera permission (prioritize front camera)
                let testStream = null;
                try {
                    console.log('üì∑ Mencoba akses kamera depan...');
                    testStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    console.log('‚úÖ Kamera depan berhasil diakses');
                } catch (frontCameraError) {
                    console.log('‚ö†Ô∏è Kamera depan gagal, mencoba kamera belakang...');
                    try {
                        testStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            } 
                        });
                        console.log('‚úÖ Kamera belakang berhasil diakses');
                    } catch (backCameraError) {
                        console.log('‚ùå Semua kamera gagal diakses');
                        throw backCameraError;
                    }
                }
                
                // Stop test stream immediately
                if (testStream) {
                    testStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('üõë Test stream dihentikan');
                    });
                }
                
                showTemporaryMessage('‚úÖ Izin kamera diberikan, memulai scanner...');
                
                // Step 2: Initialize Html5Qrcode
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                        html5QrCode.clear();
                    } catch (e) {
                        console.log('Scanner sudah bersih');
                    }
                }
                
                html5QrCode = new Html5Qrcode("qr-reader");
                
                // Step 3: Get available cameras
                const cameras = await Html5Qrcode.getCameras();
                console.log('üì± Kamera tersedia:', cameras.length);
                
                if (cameras.length === 0) {
                    alert('‚ùå Tidak ada kamera terdeteksi!\n\nPastikan:\n‚Ä¢ Perangkat memiliki kamera\n‚Ä¢ Kamera tidak rusak\n‚Ä¢ Driver kamera terinstall');
                    return;
                }
                
                // Step 4: Choose best camera
                let selectedCamera = cameras[0]; // Default to first camera
                
                // Prefer front camera for easier QR scanning
                const frontCamera = cameras.find(camera => {
                    const label = camera.label.toLowerCase();
                    return label.includes('front') || 
                           label.includes('user') || 
                           label.includes('facing') ||
                           label.includes('selfie');
                });
                
                if (frontCamera) {
                    selectedCamera = frontCamera;
                    console.log('üì∑ Menggunakan kamera depan:', selectedCamera.label);
                } else {
                    console.log('üì∑ Menggunakan kamera:', selectedCamera.label);
                }
                
                // Step 5: Scanner configuration
                const config = {
                    fps: 10, // Lower FPS for stability
                    qrbox: function(viewfinderWidth, viewfinderHeight) {
                        let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        let qrboxSize = Math.floor(minEdge * 0.6); // Smaller box for better detection
                        return {
                            width: qrboxSize,
                            height: qrboxSize
                        };
                    },
                    aspectRatio: 1.0,
                    disableFlip: false,
                    rememberLastUsedCamera: true
                };
                
                showTemporaryMessage(`üöÄ Mengaktifkan ${selectedCamera.label}...`);
                
                // Step 6: Start scanning
                await html5QrCode.start(
                    selectedCamera.id,
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                
                // Step 7: Success - Update UI
                isScanning = true;
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('stopScanBtn').classList.remove('hidden');
                document.getElementById('scanStatus').classList.remove('hidden');
                updateScannerStatus(selectedCamera.label);
                playScanReadySound();
                
                console.log('üéâ Scanner berhasil diaktifkan!');
                showCornerNotification('üéâ Scanner aktif! Arahkan ke QR Code');
                
            } catch (error) {
                console.error('‚ùå Error starting scanner:', error);
                
                // Detailed error handling
                let errorTitle = '‚ùå GAGAL MENGAKTIFKAN SCANNER';
                let errorMessage = '';
                let solutions = '';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showBrowserPermissionGuide('PERMISSION_DENIED');
                    return;
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'üì∑ Kamera tidak ditemukan';
                    solutions = '‚úÖ SOLUSI:\n‚Ä¢ Pastikan perangkat memiliki kamera\n‚Ä¢ Coba gunakan perangkat lain\n‚Ä¢ Periksa driver kamera\n‚Ä¢ Restart browser';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = '‚ö†Ô∏è Kamera sedang digunakan aplikasi lain';
                    solutions = '‚úÖ SOLUSI:\n‚Ä¢ Tutup aplikasi kamera lain\n‚Ä¢ Tutup tab browser yang menggunakan kamera\n‚Ä¢ Restart browser\n‚Ä¢ Restart perangkat jika perlu';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage = '‚öôÔ∏è Pengaturan kamera tidak didukung';
                    solutions = '‚úÖ SOLUSI:\n‚Ä¢ Coba browser lain\n‚Ä¢ Update browser ke versi terbaru\n‚Ä¢ Gunakan perangkat dengan kamera yang lebih baik';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'üîí Akses kamera diblokir karena keamanan';
                    solutions = '‚úÖ SOLUSI:\n‚Ä¢ Pastikan menggunakan HTTPS\n‚Ä¢ Coba di localhost\n‚Ä¢ Periksa sertifikat SSL\n‚Ä¢ Gunakan browser yang mendukung';
                } else if (error.name === 'AbortError') {
                    errorMessage = '‚èπÔ∏è Proses akses kamera dibatalkan';
                    solutions = '‚úÖ SOLUSI:\n‚Ä¢ Coba lagi dengan sabar\n‚Ä¢ Jangan batalkan proses izin\n‚Ä¢ Tunggu hingga dialog selesai';
                } else {
                    errorMessage = `üîß Error teknis: ${error.message}`;
                    solutions = '‚úÖ SOLUSI UMUM:\n‚Ä¢ Refresh halaman (F5)\n‚Ä¢ Restart browser\n‚Ä¢ Coba browser lain\n‚Ä¢ Periksa koneksi internet\n‚Ä¢ Update browser';
                }
                
                const fullErrorMessage = `${errorTitle}\n\n${errorMessage}\n\n${solutions}\n\nüí° TIPS TAMBAHAN:\n‚Ä¢ Gunakan Chrome/Firefox terbaru\n‚Ä¢ Pastikan di HTTPS atau localhost\n‚Ä¢ Coba di perangkat mobile\n‚Ä¢ Hubungi admin jika masih bermasalah`;
                
                alert(fullErrorMessage);
                
                // Reset UI state
                isScanning = false;
                document.getElementById('startScanBtn').classList.remove('hidden');
                document.getElementById('stopScanBtn').classList.add('hidden');
                document.getElementById('scanStatus').classList.add('hidden');
            }
        }

        // Global audio context
        let audioContext = null;
        let isAudioEnabled = false;

        // Browser permission guide functions
        function showPermissionGuide() {
            // Show small notification about upcoming permission request
            showCornerNotification('üì∑ Browser akan meminta izin kamera...');
            
            // Detect browser type for specific instructions
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            let browserName = 'Browser';
            if (isChrome) browserName = 'Chrome';
            else if (isFirefox) browserName = 'Firefox';
            else if (isSafari) browserName = 'Safari';
            else if (isEdge) browserName = 'Edge';
            
            console.log(`üåê Detected browser: ${browserName}`);
            
            // Show temporary guide
            setTimeout(() => {
                showTemporaryMessage(`üì± Siap meminta izin kamera di ${browserName}...`);
            }, 1000);
        }

        function showBrowserPermissionGuide(errorType) {
            let title = '';
            let message = '';
            let solutions = '';
            
            // Detect browser for specific instructions
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isEdge = /Edg/.test(navigator.userAgent);
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (errorType === 'PERMISSION_DENIED') {
                title = 'üö´ IZIN KAMERA DITOLAK';
                message = 'Browser memblokir akses kamera untuk website ini.';
                
                if (isChrome) {
                    solutions = `üîß CARA MENGIZINKAN DI CHROME:

üìç METODE 1 - Address Bar:
1. Lihat ikon üîí atau üì∑ di sebelah kiri URL
2. Klik ikon tersebut
3. Pilih "Izinkan" atau "Allow" untuk Kamera
4. Klik "Selesai" atau "Done"
5. Refresh halaman (F5)

üìç METODE 2 - Menu Browser:
1. Klik titik 3 (‚ãÆ) di pojok kanan atas
2. Pilih "Settings" atau "Setelan"
3. Cari "Privacy and security"
4. Klik "Site settings"
5. Pilih "Camera"
6. Cari website ini dan ubah ke "Allow"

üìç METODE 3 - Langsung:
1. Tekan Ctrl+Shift+I (buka DevTools)
2. Klik ikon üîí di address bar
3. Reset permissions dan coba lagi`;
                    
                } else if (isFirefox) {
                    solutions = `üîß CARA MENGIZINKAN DI FIREFOX:

üìç METODE 1 - Address Bar:
1. Lihat ikon üîí atau üì∑ di sebelah kiri URL
2. Klik ikon tersebut
3. Klik "Permissions" atau "Izin"
4. Ubah Camera dari "Blocked" ke "Allow"
5. Refresh halaman (F5)

üìç METODE 2 - Menu Browser:
1. Klik garis 3 (‚ò∞) di pojok kanan atas
2. Pilih "Settings" atau "Pengaturan"
3. Pilih "Privacy & Security"
4. Scroll ke "Permissions"
5. Klik "Settings" di samping "Camera"
6. Cari website ini dan ubah ke "Allow"`;
                    
                } else if (isSafari) {
                    solutions = `üîß CARA MENGIZINKAN DI SAFARI:

üìç METODE 1 - Menu Safari:
1. Klik "Safari" di menu bar
2. Pilih "Settings for This Website"
3. Ubah Camera dari "Deny" ke "Allow"
4. Refresh halaman

üìç METODE 2 - Preferences:
1. Safari ‚Üí Preferences
2. Pilih tab "Websites"
3. Pilih "Camera" di sidebar
4. Cari website ini dan ubah ke "Allow"`;
                    
                } else if (isEdge) {
                    solutions = `üîß CARA MENGIZINKAN DI EDGE:

üìç METODE 1 - Address Bar:
1. Lihat ikon üîí atau üì∑ di sebelah kiri URL
2. Klik ikon tersebut
3. Pilih "Allow" untuk Camera
4. Refresh halaman (F5)

üìç METODE 2 - Settings:
1. Klik titik 3 (...) di pojok kanan atas
2. Pilih "Settings"
3. Pilih "Site permissions"
4. Pilih "Camera"
5. Cari website ini dan ubah ke "Allow"`;
                    
                } else {
                    solutions = `üîß CARA MENGIZINKAN KAMERA:

üìç LANGKAH UMUM:
1. Cari ikon üîí atau üì∑ di address bar
2. Klik ikon tersebut
3. Pilih "Allow" atau "Izinkan" untuk Camera
4. Refresh halaman (F5)

üìç JIKA TIDAK ADA IKON:
1. Buka Settings/Pengaturan browser
2. Cari "Site Settings" atau "Izin Situs"
3. Pilih "Camera" atau "Kamera"
4. Cari website ini dan ubah ke "Allow"`;
                }
                
                if (isMobile) {
                    solutions += `\n\nüì± KHUSUS MOBILE:
‚Ä¢ Pastikan browser memiliki izin kamera di Settings HP
‚Ä¢ Coba buka di browser lain (Chrome/Firefox)
‚Ä¢ Restart browser jika perlu`;
                }
                
            } else if (errorType === 'BROWSER_NOT_SUPPORTED') {
                title = '‚ùå BROWSER TIDAK DIDUKUNG';
                message = 'Browser Anda tidak mendukung akses kamera untuk web.';
                solutions = `üîß SOLUSI:

‚úÖ BROWSER YANG DIDUKUNG:
‚Ä¢ Google Chrome (Recommended)
‚Ä¢ Mozilla Firefox
‚Ä¢ Microsoft Edge
‚Ä¢ Safari (iOS/macOS)

üì± UNTUK MOBILE:
‚Ä¢ Chrome Mobile
‚Ä¢ Firefox Mobile
‚Ä¢ Safari Mobile

‚ö†Ô∏è TIDAK DIDUKUNG:
‚Ä¢ Internet Explorer
‚Ä¢ Browser lama/outdated
‚Ä¢ Browser dengan JavaScript disabled`;
            }
            
            const fullMessage = `${title}\n\n${message}\n\n${solutions}\n\nüí° TIPS TAMBAHAN:\n‚Ä¢ Pastikan menggunakan HTTPS atau localhost\n‚Ä¢ Restart browser jika masih bermasalah\n‚Ä¢ Coba di tab/window baru\n‚Ä¢ Hubungi admin jika tetap tidak bisa`;
            
            alert(fullMessage);
            
            // Show additional visual guide
            setTimeout(() => {
                showVisualPermissionGuide();
            }, 1000);
        }

        function showVisualPermissionGuide() {
            // Create visual overlay guide
            const overlay = document.createElement('div');
            overlay.id = 'permissionGuideOverlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            overlay.style.zIndex = '9999';
            
            const guide = document.createElement('div');
            guide.className = 'bg-white rounded-2xl p-8 mx-4 max-w-md text-center shadow-2xl';
            
            guide.innerHTML = `
                <div class="text-6xl mb-4">üì∑</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Cara Mengizinkan Kamera</h3>
                
                <div class="text-left space-y-3 mb-6">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">1Ô∏è‚É£</span>
                        <span class="text-sm">Cari ikon üîí atau üì∑ di address bar</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">2Ô∏è‚É£</span>
                        <span class="text-sm">Klik ikon tersebut</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">3Ô∏è‚É£</span>
                        <span class="text-sm">Pilih "Allow" atau "Izinkan"</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">4Ô∏è‚É£</span>
                        <span class="text-sm">Refresh halaman (F5)</span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>üí° Tips:</strong> Jika tidak ada ikon di address bar, buka Settings browser ‚Üí Site Settings ‚Üí Camera
                    </p>
                </div>
                
                <button onclick="closePermissionGuide()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-medium">
                    Mengerti, Coba Lagi
                </button>
            `;
            
            overlay.appendChild(guide);
            document.body.appendChild(overlay);
            
            // Auto close after 15 seconds
            setTimeout(() => {
                closePermissionGuide();
            }, 15000);
        }

        function closePermissionGuide() {
            const overlay = document.getElementById('permissionGuideOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Initialize audio context (must be called after user interaction)
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    isAudioEnabled = true;
                    console.log('Audio context initialized');
                } catch (error) {
                    console.log('Audio not supported:', error);
                    isAudioEnabled = false;
                }
            }
            
            // Resume audio context if suspended
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    isAudioEnabled = true;
                    console.log('Audio context resumed');
                });
            }
        }

        // Create beep sound with specified frequency and duration
        function createBeep(frequency, duration, volume = 0.4) {
            if (!audioContext || !isAudioEnabled) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
                
                return true;
            } catch (error) {
                console.log('Error creating beep:', error);
                return false;
            }
        }

        // Audio notification functions
        function playLoginSound() {
            initAudioContext();
            
            if (!isAudioEnabled) {
                console.log('Login berhasil! (Audio tidak tersedia)');
                return;
            }
            
            // Pleasant login melody: C5, E5, G5
            const notes = [
                { freq: 523.25, delay: 0, duration: 0.3 },
                { freq: 659.25, delay: 0.15, duration: 0.3 },
                { freq: 783.99, delay: 0.3, duration: 0.4 }
            ];
            
            notes.forEach(note => {
                setTimeout(() => {
                    createBeep(note.freq, note.duration, 0.35);
                }, note.delay * 1000);
            });
        }

        function playScanReadySound() {
            initAudioContext();
            
            if (!isAudioEnabled) {
                console.log('Scanner siap!');
                return;
            }
            
            // Single ready beep
            createBeep(800, 0.2, 0.3);
        }

        function playScanSuccessSound() {
            initAudioContext();
            
            if (!isAudioEnabled) {
                console.log('Scan berhasil! (Audio tidak tersedia)');
                // Show visual feedback instead
                showCornerNotification('üîä Scan berhasil!');
                return;
            }
            
            // Success melody: C5, E5, G5, C6 (cheerful ascending)
            const notes = [
                { freq: 523.25, delay: 0, duration: 0.25 },
                { freq: 659.25, delay: 0.1, duration: 0.25 },
                { freq: 783.99, delay: 0.2, duration: 0.25 },
                { freq: 1046.50, delay: 0.3, duration: 0.35 }
            ];
            
            notes.forEach(note => {
                setTimeout(() => {
                    createBeep(note.freq, note.duration, 0.45);
                }, note.delay * 1000);
            });
            
            console.log('üîä Scan berhasil! Suara dimainkan.');
        }

        function playSuccessSound() {
            // Keep for compatibility
            playScanSuccessSound();
        }

        function playErrorSound() {
            initAudioContext();
            
            if (!isAudioEnabled) {
                console.log('Scan error!');
                return;
            }
            
            // Error sound: low frequency buzz
            createBeep(300, 0.5, 0.3);
        }

        // Test camera function
        async function testCamera() {
            try {
                console.log('Testing camera access...');
                showCornerNotification('üîç Mengecek kamera...');
                
                // Check if browser supports camera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showCornerNotification('‚ùå Browser tidak mendukung kamera');
                    return;
                }
                
                // Get available cameras
                const cameras = await Html5Qrcode.getCameras();
                console.log('Available cameras:', cameras);
                
                if (cameras.length === 0) {
                    showCornerNotification('‚ùå Tidak ada kamera terdeteksi');
                    return;
                }
                
                // Test camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // Stop the test stream immediately
                stream.getTracks().forEach(track => track.stop());
                
                showCornerNotification(`‚úÖ Kamera OK! Ditemukan ${cameras.length} kamera`);
                console.log('Camera test successful');
                
                // Show camera details
                let cameraInfo = 'Kamera yang tersedia:\n';
                cameras.forEach((camera, index) => {
                    cameraInfo += `${index + 1}. ${camera.label || 'Kamera ' + (index + 1)}\n`;
                });
                
                setTimeout(() => {
                    alert(cameraInfo + '\nKamera siap digunakan untuk scanning!');
                }, 1000);
                
            } catch (error) {
                console.error('Camera test failed:', error);
                
                let errorMsg = 'Test kamera gagal: ';
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'Izin kamera ditolak';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'Kamera tidak ditemukan';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Kamera sedang digunakan';
                } else {
                    errorMsg += error.message;
                }
                
                showCornerNotification('‚ùå ' + errorMsg);
                
                setTimeout(() => {
                    alert(errorMsg + '\n\nSolusi:\n‚Ä¢ Refresh halaman\n‚Ä¢ Izinkan akses kamera\n‚Ä¢ Tutup aplikasi lain yang menggunakan kamera\n‚Ä¢ Gunakan HTTPS atau localhost');
                }, 1000);
            }
        }

        // Test audio function
        function testAudio() {
            initAudioContext();
            if (isAudioEnabled) {
                createBeep(800, 0.3, 0.4);
                showCornerNotification('üîä Test audio berhasil!');
            } else {
                showCornerNotification('‚ùå Audio tidak tersedia');
            }
        }

        function stopScanning() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    document.getElementById('startScanBtn').classList.remove('hidden');
                    document.getElementById('stopScanBtn').classList.add('hidden');
                    document.getElementById('switchCameraBtn').classList.add('hidden');
                    document.getElementById('scanStatus').classList.add('hidden');
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                });
            }
        }

        function updateScannerStatus(cameraLabel = 'Kamera') {
            const statusDiv = document.getElementById('scanStatus');
            statusDiv.innerHTML = `
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                <span class="text-green-800">Scanner aktif - ${cameraLabel}</span>
            `;
        }

        function showTemporaryMessage(message) {
            const statusDiv = document.getElementById('scanStatus');
            const originalContent = statusDiv.innerHTML;
            statusDiv.innerHTML = `<span class="inline-block w-3 h-3 bg-blue-500 rounded-full animate-pulse mr-2"></span>${message}`;
            
            setTimeout(() => {
                statusDiv.innerHTML = originalContent;
            }, 2000);
        }

        function showCornerNotification(message) {
            // Create small corner notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm font-medium';
            notification.style.zIndex = '9999';
            notification.style.animation = 'slideInRight 0.3s ease-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Add slide animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    0% { transform: translateX(100%); opacity: 0; }
                    100% { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    0% { transform: translateX(0); opacity: 1; }
                    100% { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Auto remove after 2 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            }, 2000);
        }

        function showBigNotification(message) {
            // Create overlay notification
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.style.zIndex = '9999';
            
            const notification = document.createElement('div');
            notification.className = 'bg-white rounded-2xl p-8 mx-4 text-center shadow-2xl transform scale-95 transition-all duration-300';
            notification.style.maxWidth = '400px';
            notification.style.animation = 'bounceIn 0.5s ease-out';
            
            // Split message by newlines and format
            const lines = message.split('\n');
            let formattedMessage = '';
            lines.forEach((line, index) => {
                if (index === 0) {
                    formattedMessage += `<div class="text-4xl mb-4">${line}</div>`;
                } else if (index === 1) {
                    formattedMessage += `<div class="text-xl font-bold text-gray-800 mb-2">${line}</div>`;
                } else {
                    formattedMessage += `<div class="text-lg text-gray-600">${line}</div>`;
                }
            });
            
            notification.innerHTML = formattedMessage;
            overlay.appendChild(notification);
            document.body.appendChild(overlay);
            
            // Add bounce animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounceIn {
                    0% { transform: scale(0.3); opacity: 0; }
                    50% { transform: scale(1.05); }
                    70% { transform: scale(0.9); }
                    100% { transform: scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Auto remove after 2 seconds
            setTimeout(() => {
                notification.style.transform = 'scale(0.8)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            }, 2000);
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Prevent multiple scans during cooldown
            if (scanCooldown) return;
            
            console.log('QR Code detected:', decodedText);
            
            // Find member by NIM
            const member = members.find(m => m.nim === decodedText.trim());
            
            if (member) {
                // Set cooldown to prevent multiple scans
                scanCooldown = true;
                
                // Play scan success sound
                playScanSuccessSound();
                
                // Show small corner thank you notification
                showCornerNotification(`üôè Terima kasih ${member.name}!`);
                
                // Process attendance
                processAttendance(member);
                
                // Show ready for next scan after 2 seconds
                setTimeout(() => {
                    scanCooldown = false;
                    if (isScanning) {
                        playScanReadySound();
                        showTemporaryMessage('‚ú® Siap untuk scan berikutnya...');
                    }
                }, 2000);
                
            } else {
                // Play error sound for invalid QR
                playErrorSound();
                showBigNotification(`‚ùå QR Code tidak valid!\n${decodedText}\nCoba lagi...`);
                
                // Reset cooldown faster for invalid codes
                setTimeout(() => {
                    scanCooldown = false;
                }, 1500);
            }
        }

        function onScanFailure(error) {
            // Handle scan failure silently
        }

        // Attendance processing
        function processAttendance(member) {
            const today = new Date().toDateString();
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Current time in minutes
            
            // Parse work hours from settings
            const [workStartHour, workStartMin] = systemSettings.workStartTime.split(':').map(Number);
            const [workEndHour, workEndMin] = systemSettings.workEndTime.split(':').map(Number);
            const workStartMinutes = workStartHour * 60 + workStartMin;
            const workEndMinutes = workEndHour * 60 + workEndMin;
            
            // Check if member already has attendance today
            const existingAttendance = attendanceData.find(a => 
                a.memberId === member.id && 
                new Date(a.date).toDateString() === today
            );
            
            let attendanceType = '';
            let success = false;
            let isLate = false;
            let isEarlyCheckout = false;
            
            if (!existingAttendance) {
                // First scan - Check In
                // Use settings for check-in time range
                const [checkInStartHour, checkInStartMin] = systemSettings.checkInStartTime.split(':').map(Number);
                const [checkInEndHour, checkInEndMin] = systemSettings.checkInEndTime.split(':').map(Number);
                const checkInStartTime = checkInStartHour * 60 + checkInStartMin;
                const checkInEndTime = checkInEndHour * 60 + checkInEndMin;
                
                if (currentTime < checkInStartTime || currentTime > checkInEndTime) {
                    showBigNotification(`‚è∞ WAKTU ABSEN MASUK HABIS!\n${member.name}\nAbsen masuk hanya bisa dilakukan\nantara jam ${systemSettings.checkInStartTime} - ${systemSettings.checkInEndTime}\nSekarang: ${timeString}`);
                    return;
                }
                
                // Check if late - only if beyond check-in end time (not work start time)
                isLate = currentTime > checkInEndTime;
                
                attendanceData.push({
                    id: Date.now(),
                    memberId: member.id,
                    name: member.name,
                    nim: member.nim,
                    position: member.position,
                    status: 'A', // Absen Masuk
                    checkIn: timeString,
                    checkOut: null,
                    date: now.toISOString(),
                    isLate: isLate
                });
                
                attendanceType = 'masuk';
                success = true;
                
                if (isLate) {
                    const lateMinutes = currentTime - checkInEndTime;
                    console.log(`‚ö†Ô∏è ${member.name} - Absen Masuk TERLAMBAT ${lateMinutes} menit (${timeString})`);
                    showBigNotification(`‚ö†Ô∏è TERLAMBAT!\n${member.name}\nMelebihi batas waktu absen masuk\nAbsen masuk tercatat: ${timeString}`);
                } else {
                    console.log(`‚úÖ ${member.name} - Absen Masuk tepat waktu (${timeString})`);
                    showBigNotification(`‚úÖ ABSEN MASUK!\n${member.name}\nTepat waktu\nWaktu: ${timeString}`);
                }
                
            } else if (existingAttendance.status === 'A') {
                // Second scan - Check Out
                // Use settings for check-out time range
                const [checkOutStartHour, checkOutStartMin] = systemSettings.checkOutStartTime.split(':').map(Number);
                const [checkOutEndHour, checkOutEndMin] = systemSettings.checkOutEndTime.split(':').map(Number);
                const checkOutStartTime = checkOutStartHour * 60 + checkOutStartMin;
                const checkOutEndTime = checkOutEndHour * 60 + checkOutEndMin;
                
                if (currentTime < checkOutStartTime || currentTime > checkOutEndTime) {
                    showBigNotification(`‚è∞ BELUM WAKTUNYA PULANG!\n${member.name}\nAbsen pulang hanya bisa dilakukan\nantara jam ${systemSettings.checkOutStartTime} - ${systemSettings.checkOutEndTime}\nSekarang: ${timeString}`);
                    return;
                }
                
                // Check if early checkout based on system settings (workEndTime from settings)
                isEarlyCheckout = currentTime < workEndMinutes;
                
                existingAttendance.status = '.'; // Hadir
                existingAttendance.checkOut = timeString;
                existingAttendance.isEarlyCheckout = isEarlyCheckout;
                
                attendanceType = 'pulang';
                success = true;
                
                if (isEarlyCheckout) {
                    const earlyMinutes = workEndMinutes - currentTime;
                    console.log(`‚ö†Ô∏è ${member.name} - Absen Pulang lebih awal ${earlyMinutes} menit (${timeString})`);
                    showBigNotification(`‚úÖ ABSEN PULANG!\n${member.name}\nPulang ${earlyMinutes} menit lebih awal\nWaktu: ${timeString}`);
                } else {
                    console.log(`‚úÖ ${member.name} - Absen Pulang tepat waktu (${timeString})`);
                    showBigNotification(`‚úÖ ABSEN PULANG!\n${member.name}\nTepat waktu\nWaktu: ${timeString}`);
                }
                
            } else {
                // Already completed attendance
                console.log(`‚ö†Ô∏è ${member.name} - Sudah menyelesaikan absensi hari ini`);
                showBigNotification(`‚ö†Ô∏è SUDAH LENGKAP!\n${member.name}\nAbsensi hari ini sudah selesai`);
                return;
            }
            
            // Only proceed if attendance was successfully recorded
            if (success) {
                // Update displays
                updateDashboard();
                renderAttendanceTable();
                addRecentActivity(`${member.name} - ${attendanceType === 'masuk' ? 'Absen Masuk' : 'Absen Pulang'} (${timeString})`);
            }
        }

        // Dashboard updates
        function updateDashboard() {
            const today = new Date().toDateString();
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === today
            );
            
            const checkedIn = todayAttendance.length;
            const checkedOut = todayAttendance.filter(a => a.status === '.').length;
            const notCheckedOut = todayAttendance.filter(a => a.status === 'A').length;
            const percentage = members.length > 0 ? Math.round((checkedIn / members.length) * 100) : 0;
            
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('checkedIn').textContent = checkedIn;
            document.getElementById('checkedOut').textContent = checkedOut;
            document.getElementById('notCheckedOut').textContent = notCheckedOut;
            document.getElementById('attendancePercentage').textContent = percentage + '%';
        }

        function addRecentActivity(activity) {
            const recentActivityDiv = document.getElementById('recentActivity');
            const activityElement = document.createElement('div');
            activityElement.className = 'text-sm text-gray-600 py-2 border-b border-gray-100';
            activityElement.textContent = activity;
            
            if (recentActivityDiv.textContent.includes('Belum ada aktivitas')) {
                recentActivityDiv.innerHTML = '';
            }
            
            recentActivityDiv.insertBefore(activityElement, recentActivityDiv.firstChild);
            
            // Keep only last 5 activities
            const activities = recentActivityDiv.children;
            if (activities.length > 5) {
                recentActivityDiv.removeChild(activities[activities.length - 1]);
            }
        }



        // Table rendering
        function renderMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';
            
            members.forEach((member, index) => {
                const row = document.createElement('tr');
                const statusColor = member.status === 'Aktif' ? 'text-green-600' : 
                                   member.status === 'Alumni' ? 'text-blue-600' : 
                                   member.status === 'Cuti' ? 'text-yellow-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${member.nim}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${member.position}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${member.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap qr-code-cell">
                        ${member.qrCode ? `<img src="${member.qrCode}" alt="QR Code" class="w-12 h-12">` : 'Loading...'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="downloadQR(${member.id})" class="text-blue-600 hover:text-blue-900 mr-2">Download</button>
                        <button onclick="editMember(${member.id})" class="text-green-600 hover:text-green-900 mr-2">Edit</button>
                        <button onclick="deleteMember(${member.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            const today = new Date().toDateString();
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === today
            );
            
            if (todayAttendance.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data presensi hari ini</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            todayAttendance.forEach((attendance, index) => {
                let statusText = attendance.status === 'A' ? 'Absen Masuk' : 'Hadir';
                let statusColor = attendance.status === 'A' ? 'text-orange-600' : 'text-green-600';
                
                // Add late indicator
                if (attendance.isLate) {
                    statusText += ' (Terlambat)';
                    statusColor = 'text-red-600';
                }
                
                // Add early checkout indicator
                if (attendance.isEarlyCheckout && attendance.status === '.') {
                    statusText += ' (Pulang Awal)';
                    statusColor = 'text-yellow-600';
                }
                
                const timeText = attendance.checkOut ? 
                    `Masuk: ${attendance.checkIn}, Pulang: ${attendance.checkOut}` : 
                    `Masuk: ${attendance.checkIn}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${attendance.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.nim}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.position}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${timeText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editAttendance(${attendance.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button onclick="deleteAttendance(${attendance.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Modal functions
        function showResetModal() {
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('show');
            document.getElementById('resetUsername').value = '';
        }

        function resetPassword() {
            const username = document.getElementById('resetUsername').value;
            if (username) {
                alert(`Link reset password telah dikirim ke email yang terdaftar untuk username: ${username}`);
                closeResetModal();
            } else {
                alert('Masukkan username terlebih dahulu!');
            }
        }

        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('show');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('show');
        }

        function showAdminPanel() {
            document.getElementById('adminModal').classList.add('show');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
        }

        function showMemberManagement() {
            closeAdminModal();
            renderEditableMembersTable();
            document.getElementById('totalMembersCount').textContent = members.length;
            document.getElementById('memberManagementModal').classList.add('show');
        }

        function closeMemberManagementModal() {
            document.getElementById('memberManagementModal').classList.remove('show');
            cancelAddMember();
        }

        function showAddMemberForm() {
            document.getElementById('addNewMemberForm').classList.remove('hidden');
            document.getElementById('newMemberName').focus();
        }

        function cancelAddMember() {
            document.getElementById('addNewMemberForm').classList.add('hidden');
            // Clear form
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberNTA').value = '';
            document.getElementById('newMemberPosition').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberStatus').value = 'Aktif';
        }

        function showManualAttendance() {
            closeAdminModal();
            renderManualAttendanceList();
            document.getElementById('manualAttendanceModal').classList.add('show');
        }

        function closeManualAttendanceModal() {
            document.getElementById('manualAttendanceModal').classList.remove('show');
        }

        function showFullReport() {
            closeAdminModal();
            document.getElementById('fullReportModal').classList.add('show');
        }

        function closeFullReportModal() {
            document.getElementById('fullReportModal').classList.remove('show');
        }

        function showSystemSettings() {
            closeAdminModal();
            // Load current settings
            document.getElementById('workStartTime').value = systemSettings.workStartTime;
            document.getElementById('workEndTime').value = systemSettings.workEndTime;
            document.getElementById('checkInStartTime').value = systemSettings.checkInStartTime;
            document.getElementById('checkInEndTime').value = systemSettings.checkInEndTime;
            document.getElementById('checkOutStartTime').value = systemSettings.checkOutStartTime;
            document.getElementById('checkOutEndTime').value = systemSettings.checkOutEndTime;
            document.getElementById('enableNotifications').checked = systemSettings.enableNotifications;
            document.getElementById('enableWhatsApp').checked = systemSettings.enableWhatsApp;
            document.getElementById('adminWhatsApp').value = systemSettings.adminWhatsApp;
            document.getElementById('systemSettingsModal').classList.add('show');
        }

        function closeSystemSettingsModal() {
            document.getElementById('systemSettingsModal').classList.remove('show');
        }

        function showEditAttendanceModal(attendance) {
            document.getElementById('editAttendanceId').value = attendance.id;
            document.getElementById('editAttendanceName').value = attendance.name;
            document.getElementById('editAttendanceStatus').value = attendance.status;
            
            // Convert time strings to time input format
            if (attendance.checkIn) {
                const checkInTime = attendance.checkIn.split(':').slice(0, 2).join(':');
                document.getElementById('editCheckInTime').value = checkInTime;
            }
            if (attendance.checkOut) {
                const checkOutTime = attendance.checkOut.split(':').slice(0, 2).join(':');
                document.getElementById('editCheckOutTime').value = checkOutTime;
            }
            
            document.getElementById('editAttendanceModal').classList.add('show');
        }

        function closeEditAttendanceModal() {
            document.getElementById('editAttendanceModal').classList.remove('show');
            document.getElementById('editAttendanceForm').reset();
        }

        // Manual attendance functions
        function renderManualAttendanceList() {
            const container = document.getElementById('manualAttendanceList');
            container.innerHTML = '';
            
            const today = new Date().toDateString();
            
            members.forEach(member => {
                const hasAttendance = attendanceData.some(a => 
                    a.memberId === member.id && 
                    new Date(a.date).toDateString() === today
                );
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${member.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${member.nim})</span>
                        ${hasAttendance ? '<span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Sudah Absen</span>' : ''}
                    </div>
                    <div class="space-x-2">
                        <button onclick="markPresent(${member.id})" 
                                class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition ${hasAttendance ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${hasAttendance ? 'disabled' : ''}>
                            Hadir
                        </button>
                        <button onclick="markAbsent(${member.id})" 
                                class="px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 transition">
                            Tidak Hadir
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function markPresent(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID');
                
                attendanceData.push({
                    id: Date.now(),
                    memberId: member.id,
                    name: member.name,
                    nim: member.nim,
                    position: member.position,
                    status: '.', // Hadir
                    checkIn: timeString,
                    checkOut: timeString,
                    date: now.toISOString()
                });
                
                updateDashboard();
                renderAttendanceTable();
                renderManualAttendanceList();
                addRecentActivity(`${member.name} - Absensi Manual (${timeString})`);
            }
        }

        function markAbsent(memberId) {
            // Remove attendance if exists
            const today = new Date().toDateString();
            attendanceData = attendanceData.filter(a => 
                !(a.memberId === memberId && new Date(a.date).toDateString() === today)
            );
            
            updateDashboard();
            renderAttendanceTable();
            renderManualAttendanceList();
        }

        function markAllPresent() {
            const today = new Date().toDateString();
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            
            members.forEach(member => {
                const hasAttendance = attendanceData.some(a => 
                    a.memberId === member.id && 
                    new Date(a.date).toDateString() === today
                );
                
                if (!hasAttendance) {
                    attendanceData.push({
                        id: Date.now() + member.id,
                        memberId: member.id,
                        name: member.name,
                        nim: member.nim,
                        position: member.position,
                        status: '.', // Hadir
                        checkIn: timeString,
                        checkOut: timeString,
                        date: now.toISOString()
                    });
                }
            });
            
            updateDashboard();
            renderAttendanceTable();
            renderManualAttendanceList();
            addRecentActivity(`Semua anggota - Absensi Manual (${timeString})`);
        }

        function markAllAbsent() {
            const today = new Date().toDateString();
            attendanceData = attendanceData.filter(a => 
                new Date(a.date).toDateString() !== today
            );
            
            updateDashboard();
            renderAttendanceTable();
            renderManualAttendanceList();
        }

        // Render editable members table
        function renderEditableMembersTable() {
            const tbody = document.getElementById('editableMembersTableBody');
            tbody.innerHTML = '';
            
            members.forEach((member, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusOptions = ['Aktif', 'Tidak Aktif', 'Alumni', 'Cuti'];
                const positionOptions = ['KDA', 'Pemangku Adat', 'Kerani I', 'Kerani II', 'Kerani III', 'Bangkir I', 'Bangkir II', 'Bangkir III', 'Keilmuan I', 'Keilmuan II', 'Keilmuan III', 'Sarpras I', 'Sarpras II', 'Sarpras III', 'Humas', 'Humas & IT', 'KWU I', 'KWU II', 'KWU III', 'Warga', 'Tamu'];
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3">
                        <input type="text" value="${member.name}" 
                               onchange="updateMemberField(${member.id}, 'name', this.value)"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${member.nim}" 
                               onchange="updateMemberField(${member.id}, 'nim', this.value)"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="updateMemberField(${member.id}, 'position', this.value)"
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                            ${positionOptions.map(pos => 
                                `<option value="${pos}" ${pos === member.position ? 'selected' : ''}>${pos}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <input type="tel" value="${member.phone || ''}" 
                               onchange="updateMemberField(${member.id}, 'phone', this.value)"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="updateMemberField(${member.id}, 'status', this.value)"
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                            ${statusOptions.map(status => 
                                `<option value="${status}" ${status === member.status ? 'selected' : ''}>${status}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="deleteMemberFromTable(${member.id})" 
                                class="text-red-600 hover:text-red-900 text-sm px-2 py-1 rounded hover:bg-red-50">
                            üóëÔ∏è Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update member field
        function updateMemberField(memberId, field, value) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                // Check for duplicate NIM if updating nim field
                if (field === 'nim' && value !== member.nim) {
                    if (members.some(m => m.nim === value && m.id !== memberId)) {
                        alert('NTA sudah terdaftar untuk anggota lain!');
                        renderEditableMembersTable(); // Reset the table
                        return;
                    }
                }
                
                member[field] = value;
                
                // If NIM changed, regenerate QR code
                if (field === 'nim') {
                    generateQRCode(value).then(canvas => {
                        if (canvas) {
                            member.qrCode = canvas.toDataURL();
                        }
                    });
                }
                
                // Update attendance records if name, nim, or position changed
                if (['name', 'nim', 'position'].includes(field)) {
                    attendanceData.forEach(a => {
                        if (a.memberId === memberId) {
                            a[field] = value;
                        }
                    });
                }
            }
        }

        // Add new member from form
        function addNewMemberFromForm() {
            const name = document.getElementById('newMemberName').value.trim();
            const nim = document.getElementById('newMemberNTA').value.trim();
            const position = document.getElementById('newMemberPosition').value;
            const phone = document.getElementById('newMemberPhone').value.trim();
            const status = document.getElementById('newMemberStatus').value;
            
            if (!name || !nim || !position) {
                alert('Mohon lengkapi data yang wajib diisi (Nama, NTA, Jabatan)!');
                return;
            }
            
            // Check if NIM already exists
            if (members.some(m => m.nim === nim)) {
                alert('NTA sudah terdaftar!');
                return;
            }
            
            const newMember = {
                id: Date.now(),
                name: name,
                nim: nim,
                position: position,
                phone: phone,
                status: status,
                qrCode: ''
            };
            
            members.push(newMember);
            
            // Generate QR code
            generateQRCode(nim).then(canvas => {
                if (canvas) {
                    newMember.qrCode = canvas.toDataURL();
                }
            });
            
            // Update displays
            renderEditableMembersTable();
            renderMembersTable();
            updateDashboard();
            document.getElementById('totalMembersCount').textContent = members.length;
            
            // Clear and hide form
            cancelAddMember();
            
            alert('Anggota baru berhasil ditambahkan!');
        }

        // Delete member from table
        function deleteMemberFromTable(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member && confirm(`Yakin ingin menghapus ${member.name}? Data presensi terkait juga akan dihapus.`)) {
                // Remove member
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    members.splice(memberIndex, 1);
                }
                
                // Remove related attendance data
                attendanceData = attendanceData.filter(a => a.memberId !== memberId);
                
                // Update displays
                renderEditableMembersTable();
                renderMembersTable();
                renderAttendanceTable();
                updateDashboard();
                document.getElementById('totalMembersCount').textContent = members.length;
            }
        }

        // Save all changes
        function saveAllChanges() {
            // Regenerate QR codes for all members to ensure consistency
            let qrPromises = members.map(member => {
                return generateQRCode(member.nim).then(canvas => {
                    if (canvas) {
                        member.qrCode = canvas.toDataURL();
                    }
                });
            });
            
            Promise.all(qrPromises).then(() => {
                renderMembersTable();
                renderAttendanceTable();
                updateDashboard();
                alert('Semua perubahan berhasil disimpan!');
            });
        }

        // Member management (legacy functions for compatibility)
        function addNewMember() {
            const name = document.getElementById('memberName').value;
            const nim = document.getElementById('memberNTA').value;
            const position = document.getElementById('memberPosition').value;
            const phone = document.getElementById('memberPhone').value;
            const status = document.getElementById('memberStatus').value;
            
            if (!name || !nim || !position) {
                alert('Mohon lengkapi data yang wajib diisi!');
                return;
            }
            
            // Check if NIM already exists
            if (members.some(m => m.nim === nim)) {
                alert('NTA sudah terdaftar!');
                return;
            }
            
            const newMember = {
                id: Date.now(),
                name: name,
                nim: nim,
                position: position,
                phone: phone,
                status: status,
                qrCode: ''
            };
            
            members.push(newMember);
            
            // Generate QR code
            generateQRCode(nim).then(canvas => {
                if (canvas) {
                    newMember.qrCode = canvas.toDataURL();
                    renderMembersTable();
                }
            });
            
            updateDashboard();
            closeAddMemberModal();
            alert('Anggota baru berhasil ditambahkan!');
        }

        function showAddMemberModal() {
            editingMemberId = null;
            document.getElementById('memberModalTitle').textContent = 'Tambah Anggota';
            document.getElementById('addMemberForm').reset();
            document.getElementById('addMemberModal').classList.add('show');
        }

        function closeAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('show');
            document.getElementById('addMemberForm').reset();
            editingMemberId = null;
        }

        function editMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                editingMemberId = memberId;
                document.getElementById('memberModalTitle').textContent = 'Edit Anggota';
                document.getElementById('editMemberId').value = memberId;
                document.getElementById('memberName').value = member.name;
                document.getElementById('memberNTA').value = member.nim;
                document.getElementById('memberPosition').value = member.position;
                document.getElementById('memberPhone').value = member.phone;
                document.getElementById('memberStatus').value = member.status;
                document.getElementById('addMemberModal').classList.add('show');
            }
        }

        function updateMember() {
            const memberId = parseInt(document.getElementById('editMemberId').value);
            const member = members.find(m => m.id === memberId);
            
            if (member) {
                const name = document.getElementById('memberName').value;
                const nim = document.getElementById('memberNTA').value;
                const position = document.getElementById('memberPosition').value;
                const phone = document.getElementById('memberPhone').value;
                const status = document.getElementById('memberStatus').value;
                
                // Check if NIM already exists for other members
                if (members.some(m => m.nim === nim && m.id !== memberId)) {
                    alert('NTA sudah terdaftar untuk anggota lain!');
                    return;
                }
                
                member.name = name;
                member.nim = nim;
                member.position = position;
                member.phone = phone;
                member.status = status;
                
                // Regenerate QR if NIM changed
                generateQRCode(nim).then(canvas => {
                    if (canvas) {
                        member.qrCode = canvas.toDataURL();
                        renderMembersTable();
                    }
                });
                
                // Update attendance records
                attendanceData.forEach(a => {
                    if (a.memberId === memberId) {
                        a.name = name;
                        a.nim = nim;
                        a.position = position;
                    }
                });
                
                renderAttendanceTable();
                closeAddMemberModal();
                alert('Data anggota berhasil diperbarui!');
            }
        }

        function deleteMember(memberId) {
            if (confirm('Yakin ingin menghapus anggota ini? Data presensi terkait juga akan dihapus.')) {
                // Remove member
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    members.splice(memberIndex, 1);
                }
                
                // Remove related attendance data
                attendanceData = attendanceData.filter(a => a.memberId !== memberId);
                
                updateDashboard();
                renderMembersTable();
                renderAttendanceTable();
                alert('Anggota berhasil dihapus!');
            }
        }

        // Attendance management
        function editAttendance(attendanceId) {
            const attendance = attendanceData.find(a => a.id === attendanceId);
            if (attendance) {
                showEditAttendanceModal(attendance);
            }
        }

        function updateAttendance() {
            const attendanceId = parseInt(document.getElementById('editAttendanceId').value);
            const attendance = attendanceData.find(a => a.id === attendanceId);
            
            if (attendance) {
                attendance.status = document.getElementById('editAttendanceStatus').value;
                
                const checkInTime = document.getElementById('editCheckInTime').value;
                const checkOutTime = document.getElementById('editCheckOutTime').value;
                
                if (checkInTime) {
                    attendance.checkIn = checkInTime + ':00';
                }
                if (checkOutTime && attendance.status === '.') {
                    attendance.checkOut = checkOutTime + ':00';
                } else if (attendance.status === 'A') {
                    attendance.checkOut = null;
                }
                
                updateDashboard();
                renderAttendanceTable();
                closeEditAttendanceModal();
                alert('Data presensi berhasil diperbarui!');
            }
        }

        function deleteAttendance(attendanceId) {
            if (confirm('Yakin ingin menghapus data presensi ini?')) {
                attendanceData = attendanceData.filter(a => a.id !== attendanceId);
                updateDashboard();
                renderAttendanceTable();
            }
        }

        // Report functions
        function generateReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value);
            const endDate = new Date(document.getElementById('reportEndDate').value);
            
            if (startDate > endDate) {
                alert('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
                return;
            }
            
            const filteredData = attendanceData.filter(a => {
                const attendanceDate = new Date(a.date);
                return attendanceDate >= startDate && attendanceDate <= endDate;
            });
            
            const reportContent = document.getElementById('reportContent');
            
            if (filteredData.length === 0) {
                reportContent.innerHTML = '<p class="text-center text-gray-500">Tidak ada data presensi pada periode tersebut.</p>';
                return;
            }
            
            // Group by date
            const groupedData = {};
            filteredData.forEach(attendance => {
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                if (!groupedData[date]) {
                    groupedData[date] = [];
                }
                groupedData[date].push(attendance);
            });
            
            let html = '<div class="space-y-6">';
            
            // Summary
            const totalDays = Object.keys(groupedData).length;
            const totalAttendance = filteredData.length;
            const totalPresent = filteredData.filter(a => a.status === '.').length;
            
            html += `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">üìä Ringkasan Laporan</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>Total Hari: <strong>${totalDays}</strong></div>
                        <div>Total Kehadiran: <strong>${totalAttendance}</strong></div>
                        <div>Hadir Penuh: <strong>${totalPresent}</strong></div>
                    </div>
                </div>
            `;
            
            // Daily reports
            Object.keys(groupedData).sort().forEach(date => {
                const dayData = groupedData[date];
                const presentCount = dayData.filter(a => a.status === '.').length;
                const checkInCount = dayData.length;
                
                html += `
                    <div class="border rounded-lg p-4">
                        <h5 class="font-semibold mb-3">${date} (${checkInCount} masuk, ${presentCount} hadir)</h5>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left">Nama</th>
                                        <th class="px-3 py-2 text-left">NTA</th>
                                        <th class="px-3 py-2 text-left">Status</th>
                                        <th class="px-3 py-2 text-left">Jam Masuk</th>
                                        <th class="px-3 py-2 text-left">Jam Pulang</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                dayData.forEach(attendance => {
                    const statusText = attendance.status === 'A' ? 'Absen Masuk' : 'Hadir';
                    const statusColor = attendance.status === 'A' ? 'text-orange-600' : 'text-green-600';
                    
                    html += `
                        <tr class="border-t">
                            <td class="px-3 py-2">${attendance.name}</td>
                            <td class="px-3 py-2">${attendance.nim}</td>
                            <td class="px-3 py-2 ${statusColor}">${statusText}</td>
                            <td class="px-3 py-2">${attendance.checkIn || '-'}</td>
                            <td class="px-3 py-2">${attendance.checkOut || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            reportContent.innerHTML = html;
        }

        function exportReportExcel() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const filteredData = attendanceData.filter(a => {
                const attendanceDate = new Date(a.date);
                return attendanceDate >= new Date(startDate) && attendanceDate <= new Date(endDate);
            });
            
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            const ws_data = [
                ['Laporan Presensi Mahesa Scout'],
                [`Periode: ${startDate} s/d ${endDate}`],
                [],
                ['No', 'Tanggal', 'Nama', 'NTA', 'Jabatan', 'Status', 'Jam Masuk', 'Jam Pulang']
            ];
            
            filteredData.forEach((attendance, index) => {
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const statusText = attendance.status === 'A' ? 'Absen Masuk' : 'Hadir';
                
                ws_data.push([
                    index + 1,
                    date,
                    attendance.name,
                    attendance.nim,
                    attendance.position,
                    statusText,
                    attendance.checkIn || '-',
                    attendance.checkOut || '-'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Presensi');
            
            const fileName = `Laporan_Presensi_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function printReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Laporan Presensi Mahesa Scout</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                            .text-green-600 { color: #059669; }
                            .text-orange-600 { color: #ea580c; }
                        </style>
                    </head>
                    <body>
                        <h1>Laporan Presensi Mahesa Scout</h1>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // System settings functions
        function saveSettings() {
            systemSettings.workStartTime = document.getElementById('workStartTime').value;
            systemSettings.workEndTime = document.getElementById('workEndTime').value;
            systemSettings.checkInStartTime = document.getElementById('checkInStartTime').value;
            systemSettings.checkInEndTime = document.getElementById('checkInEndTime').value;
            systemSettings.checkOutStartTime = document.getElementById('checkOutStartTime').value;
            systemSettings.checkOutEndTime = document.getElementById('checkOutEndTime').value;
            systemSettings.enableNotifications = document.getElementById('enableNotifications').checked;
            systemSettings.enableWhatsApp = document.getElementById('enableWhatsApp').checked;
            systemSettings.adminWhatsApp = document.getElementById('adminWhatsApp').value;
            
            // Show confirmation with current settings
            let settingsInfo = `‚úÖ Pengaturan berhasil disimpan!\n\n`;
            settingsInfo += `üïê JAM KERJA STANDAR:\n`;
            settingsInfo += `‚Ä¢ Masuk: ${systemSettings.workStartTime}\n`;
            settingsInfo += `‚Ä¢ Pulang: ${systemSettings.workEndTime}\n\n`;
            settingsInfo += `‚è∞ BATAS WAKTU ABSENSI:\n`;
            settingsInfo += `‚Ä¢ Absen Masuk: ${systemSettings.checkInStartTime} - ${systemSettings.checkInEndTime}\n`;
            settingsInfo += `‚Ä¢ Absen Pulang: ${systemSettings.checkOutStartTime} - ${systemSettings.checkOutEndTime}\n\n`;
            settingsInfo += `Pengaturan akan langsung berlaku untuk absensi selanjutnya.`;
            
            alert(settingsInfo);
            closeSystemSettingsModal();
        }

        function changePassword() {
            const newPassword = prompt('Masukkan password baru:');
            if (newPassword) {
                alert('Password berhasil diubah! Gunakan password baru untuk login selanjutnya.');
            }
        }

        function backupData() {
            const backupData = {
                members: members,
                attendanceData: attendanceData,
                systemSettings: systemSettings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `backup_mahesa_scout_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Backup data berhasil diunduh!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm('Import data akan mengganti semua data yang ada. Lanjutkan?')) {
                                if (data.members) members.splice(0, members.length, ...data.members);
                                if (data.attendanceData) attendanceData.splice(0, attendanceData.length, ...data.attendanceData);
                                if (data.systemSettings) Object.assign(systemSettings, data.systemSettings);
                                
                                updateDashboard();
                                renderMembersTable();
                                renderAttendanceTable();
                                alert('Data berhasil diimport!');
                            }
                        } catch (error) {
                            alert('File tidak valid!');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportAllData() {
            const exportData = {
                members: members,
                attendanceData: attendanceData,
                systemSettings: systemSettings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `export_mahesa_scout_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Export data berhasil diunduh!');
        }

        // Utility functions
        function downloadQR(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member && member.qrCode) {
                const link = document.createElement('a');
                link.download = `QR_${member.name}_${member.nim}.png`;
                link.href = member.qrCode;
                link.click();
            }
        }

        function exportExcel() {
            const today = new Date().toDateString();
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === today
            );
            
            if (todayAttendance.length === 0) {
                alert('Tidak ada data presensi hari ini untuk diekspor!');
                return;
            }
            
            const ws_data = [
                ['Presensi Mahesa Scout'],
                [`Tanggal: ${new Date().toLocaleDateString('id-ID')}`],
                [],
                ['No', 'Nama', 'NTA', 'Jabatan', 'Status', 'Jam Masuk', 'Jam Pulang']
            ];
            
            todayAttendance.forEach((attendance, index) => {
                const statusText = attendance.status === 'A' ? 'Absen Masuk' : 'Hadir';
                ws_data.push([
                    index + 1,
                    attendance.name,
                    attendance.nim,
                    attendance.position,
                    statusText,
                    attendance.checkIn || '-',
                    attendance.checkOut || '-'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Presensi Hari Ini');
            
            const fileName = `Presensi_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Mass WhatsApp functions
        let selectedMembers = [];
        
        function showMassWhatsApp() {
            renderMemberSelectionList();
            updateMessageTemplate();
            document.getElementById('massWhatsAppModal').classList.add('show');
        }
        
        function sendMassWhatsApp() {
            showMassWhatsApp();
        }
        
        function closeMassWhatsAppModal() {
            document.getElementById('massWhatsAppModal').classList.remove('show');
            selectedMembers = [];
        }
        
        function renderMemberSelectionList() {
            const container = document.getElementById('memberSelectionList');
            container.innerHTML = '';
            
            const today = new Date().toDateString();
            
            members.forEach(member => {
                const hasAttendance = attendanceData.some(a => 
                    a.memberId === member.id && 
                    new Date(a.date).toDateString() === today
                );
                
                const attendance = attendanceData.find(a => 
                    a.memberId === member.id && 
                    new Date(a.date).toDateString() === today
                );
                
                let statusBadge = '';
                if (hasAttendance) {
                    if (attendance.status === '.') {
                        statusBadge = '<span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Hadir Lengkap</span>';
                    } else {
                        statusBadge = '<span class="ml-2 px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">Baru Masuk</span>';
                    }
                } else {
                    statusBadge = '<span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded">Belum Hadir</span>';
                }
                
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
                div.innerHTML = `
                    <input type="checkbox" id="member_${member.id}" value="${member.id}" 
                           onchange="updateSelectedMembers()" 
                           class="mr-3 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                    <label for="member_${member.id}" class="flex-1 cursor-pointer">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-medium">${member.name}</span>
                                <span class="text-sm text-gray-500 ml-2">(${member.nim} - ${member.position})</span>
                                ${member.phone ? `<span class="text-xs text-blue-600 ml-2">üì± ${member.phone}</span>` : '<span class="text-xs text-red-500 ml-2">‚ùå No HP</span>'}
                            </div>
                            ${statusBadge}
                        </div>
                    </label>
                `;
                container.appendChild(div);
            });
        }
        
        function updateSelectedMembers() {
            const checkboxes = document.querySelectorAll('#memberSelectionList input[type="checkbox"]:checked');
            selectedMembers = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            document.getElementById('selectedCount').textContent = selectedMembers.length;
            
            if (selectedMembers.length === 0) {
                document.getElementById('selectedMembersInfo').textContent = 'Belum ada yang dipilih';
            } else {
                const selectedNames = selectedMembers.map(id => {
                    const member = members.find(m => m.id === id);
                    return member ? member.name : '';
                }).filter(name => name).slice(0, 3);
                
                let info = selectedNames.join(', ');
                if (selectedMembers.length > 3) {
                    info += ` dan ${selectedMembers.length - 3} lainnya`;
                }
                document.getElementById('selectedMembersInfo').textContent = info;
            }
        }
        
        function selectAllMembers() {
            const checkboxes = document.querySelectorAll('#memberSelectionList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedMembers();
        }
        
        function selectPresentMembers() {
            const today = new Date().toDateString();
            const checkboxes = document.querySelectorAll('#memberSelectionList input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                const memberId = parseInt(cb.value);
                const hasAttendance = attendanceData.some(a => 
                    a.memberId === memberId && 
                    new Date(a.date).toDateString() === today
                );
                cb.checked = hasAttendance;
            });
            updateSelectedMembers();
        }
        
        function selectAbsentMembers() {
            const today = new Date().toDateString();
            const checkboxes = document.querySelectorAll('#memberSelectionList input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                const memberId = parseInt(cb.value);
                const hasAttendance = attendanceData.some(a => 
                    a.memberId === memberId && 
                    new Date(a.date).toDateString() === today
                );
                cb.checked = !hasAttendance;
            });
            updateSelectedMembers();
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('#memberSelectionList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedMembers();
        }
        
        function updateMessageTemplate() {
            const template = document.getElementById('messageTemplate').value;
            const messageContent = document.getElementById('messageContent');
            const today = new Date().toLocaleDateString('id-ID');
            
            let message = '';
            
            switch (template) {
                case 'reminder':
                    message = `üèïÔ∏è *PENGINGAT ABSENSI - MAHESA SCOUT*\n\n`;
                    message += `Halo {nama}! üëã\n\n`;
                    message += `üìÖ Tanggal: ${today}\n`;
                    message += `üÜî NTA: {nim}\n`;
                    message += `üë§ Jabatan: {jabatan}\n\n`;
                    message += `‚è∞ *Jangan lupa untuk melakukan absensi hari ini!*\n\n`;
                    message += `Scan QR Code Anda untuk:\n`;
                    message += `‚Ä¢ Absen Masuk (06:00 - 12:00)\n`;
                    message += `‚Ä¢ Absen Pulang (15:00 - 23:59)\n\n`;
                    message += `Terima kasih! üôè\n\n`;
                    message += `_Sistem Absensi Digital Mahesa Scout_`;
                    break;
                    
                case 'thanks':
                    message = `üèïÔ∏è *TERIMA KASIH - MAHESA SCOUT*\n\n`;
                    message += `Halo {nama}! üéâ\n\n`;
                    message += `‚úÖ *Terima kasih telah hadir hari ini!*\n`;
                    message += `üìÖ Tanggal: ${today}\n`;
                    message += `üÜî NTA: {nim}\n`;
                    message += `üë§ Jabatan: {jabatan}\n\n`;
                    message += `Partisipasi aktif Anda sangat berarti bagi kemajuan Mahesa Scout! üôè\n\n`;
                    message += `Sampai jumpa di kegiatan selanjutnya! üòä\n\n`;
                    message += `_Salam Scout - Mahesa Scout_`;
                    break;
                    
                case 'absent':
                    message = `üèïÔ∏è *PEMBERITAHUAN - MAHESA SCOUT*\n\n`;
                    message += `Halo {nama},\n\n`;
                    message += `üìÖ Tanggal: ${today}\n`;
                    message += `üÜî NTA: {nim}\n`;
                    message += `üë§ Jabatan: {jabatan}\n\n`;
                    message += `‚ùå *Kami belum menerima absensi Anda hari ini.*\n\n`;
                    message += `Jika ada kendala atau alasan tertentu, silakan hubungi admin.\n\n`;
                    message += `Kehadiran Anda sangat penting bagi kegiatan Mahesa Scout! üèïÔ∏è\n\n`;
                    message += `_Admin Mahesa Scout_`;
                    break;
                    
                case 'custom':
                    message = `üèïÔ∏è *MAHESA SCOUT*\n\n`;
                    message += `Halo {nama}!\n\n`;
                    message += `üìÖ Tanggal: ${today}\n`;
                    message += `üÜî NTA: {nim}\n`;
                    message += `üë§ Jabatan: {jabatan}\n\n`;
                    message += `[Tulis pesan kustom Anda di sini]\n\n`;
                    message += `_Mahesa Scout_`;
                    break;
            }
            
            messageContent.value = message;
        }
        
        function sendSelectedWhatsApp() {
            if (selectedMembers.length === 0) {
                alert('Pilih minimal satu anggota untuk mengirim WhatsApp!');
                return;
            }
            
            const messageTemplate = document.getElementById('messageContent').value;
            if (!messageTemplate.trim()) {
                alert('Pesan tidak boleh kosong!');
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            selectedMembers.forEach((memberId, index) => {
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                if (!member.phone) {
                    failCount++;
                    return;
                }
                
                // Personalize message
                let personalizedMessage = messageTemplate
                    .replace(/{nama}/g, member.name)
                    .replace(/{nim}/g, member.nim)
                    .replace(/{jabatan}/g, member.position);
                
                // Clean phone number
                let phoneNumber = member.phone.replace(/\D/g, '');
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '62' + phoneNumber.substring(1);
                } else if (!phoneNumber.startsWith('62')) {
                    phoneNumber = '62' + phoneNumber;
                }
                
                // Open WhatsApp with delay to prevent browser blocking
                setTimeout(() => {
                    const encodedMessage = encodeURIComponent(personalizedMessage);
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    successCount++;
                    
                    // Show progress
                    showCornerNotification(`üì± Membuka WhatsApp ${index + 1}/${selectedMembers.length}: ${member.name}`);
                }, index * 1000); // 1 second delay between each
            });
            
            // Show summary after all are processed
            setTimeout(() => {
                let summary = `üì± *RINGKASAN PENGIRIMAN WHATSAPP*\n\n`;
                summary += `‚úÖ Berhasil dibuka: ${successCount}\n`;
                if (failCount > 0) {
                    summary += `‚ùå Gagal (no HP kosong): ${failCount}\n`;
                }
                summary += `\nSilakan kirim pesan satu per satu di tab WhatsApp yang terbuka.`;
                
                alert(summary);
                closeMassWhatsAppModal();
            }, selectedMembers.length * 1000 + 1000);
        }

        // Send daily report to admin
        function sendWhatsApp() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === new Date().toDateString()
            );
            
            const presentCount = todayAttendance.filter(a => a.status === '.').length;
            const checkInOnlyCount = todayAttendance.filter(a => a.status === 'A').length;
            const absentCount = members.length - todayAttendance.length;
            
            let message = `üèïÔ∏è *LAPORAN HARIAN PRESENSI MAHESA SCOUT*\n`;
            message += `üìÖ Tanggal: ${today}\n`;
            message += `‚è∞ Waktu Laporan: ${new Date().toLocaleTimeString('id-ID')}\n\n`;
            
            message += `üìä *RINGKASAN KEHADIRAN:*\n`;
            message += `üë• Total Anggota: ${members.length}\n`;
            message += `‚úÖ Hadir Lengkap: ${presentCount}\n`;
            message += `‚è∞ Baru Absen Masuk: ${checkInOnlyCount}\n`;
            message += `‚ùå Belum Hadir: ${absentCount}\n`;
            message += `üìà Persentase Kehadiran: ${Math.round((todayAttendance.length / members.length) * 100)}%\n\n`;
            
            if (todayAttendance.length > 0) {
                message += `üë• *DAFTAR YANG SUDAH ABSEN:*\n`;
                todayAttendance.forEach((attendance, index) => {
                    const statusIcon = attendance.status === '.' ? '‚úÖ' : '‚è∞';
                    const statusText = attendance.status === '.' ? 'Hadir' : 'Masuk';
                    message += `${index + 1}. ${statusIcon} ${attendance.name}\n`;
                    message += `   üìã ${attendance.nim} - ${attendance.position}\n`;
                    message += `   üïê ${attendance.checkIn}${attendance.checkOut ? ` - ${attendance.checkOut}` : ''}\n\n`;
                });
            }
            
            if (absentCount > 0) {
                message += `‚ùå *BELUM HADIR (${absentCount} orang):*\n`;
                const absentMembers = members.filter(member => 
                    !todayAttendance.some(a => a.memberId === member.id)
                );
                absentMembers.forEach((member, index) => {
                    message += `${index + 1}. ${member.name} (${member.nim})\n`;
                });
                message += `\n`;
            }
            
            message += `_Sistem Absensi Digital Mahesa Scout_\n`;
            message += `_Laporan otomatis - ${new Date().toISOString()}_`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // Send WhatsApp to specific admin number
        function sendAdminWhatsApp() {
            let adminPhone = systemSettings.adminWhatsApp;
            
            if (!adminPhone) {
                adminPhone = prompt('Masukkan nomor WhatsApp admin (contoh: 081234567890):');
                if (!adminPhone) return;
                
                // Save for future use
                systemSettings.adminWhatsApp = adminPhone;
            }
            
            const today = new Date().toLocaleDateString('id-ID');
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === new Date().toDateString()
            );
            
            const presentCount = todayAttendance.filter(a => a.status === '.').length;
            const checkInOnlyCount = todayAttendance.filter(a => a.status === 'A').length;
            const absentCount = members.length - todayAttendance.length;
            
            let message = `üèïÔ∏è *LAPORAN ADMIN - MAHESA SCOUT*\n`;
            message += `üìÖ ${today} | ‚è∞ ${new Date().toLocaleTimeString('id-ID')}\n\n`;
            
            message += `üìä *STATISTIK HARI INI:*\n`;
            message += `‚Ä¢ Total: ${members.length} anggota\n`;
            message += `‚Ä¢ Hadir: ${presentCount} ‚úÖ\n`;
            message += `‚Ä¢ Masuk saja: ${checkInOnlyCount} ‚è∞\n`;
            message += `‚Ä¢ Belum hadir: ${absentCount} ‚ùå\n`;
            message += `‚Ä¢ Persentase: ${Math.round((todayAttendance.length / members.length) * 100)}%\n\n`;
            
            if (checkInOnlyCount > 0) {
                message += `‚ö†Ô∏è *PERLU PERHATIAN - BELUM ABSEN PULANG:*\n`;
                const notCheckedOut = todayAttendance.filter(a => a.status === 'A');
                notCheckedOut.forEach((attendance, index) => {
                    message += `${index + 1}. ${attendance.name} (${attendance.nim})\n`;
                });
                message += `\n`;
            }
            
            message += `_Dashboard: Sistem Absensi Digital_`;
            
            // Clean phone number
            let phoneNumber = adminPhone.replace(/\D/g, '');
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '62' + phoneNumber.substring(1);
            } else if (!phoneNumber.startsWith('62')) {
                phoneNumber = '62' + phoneNumber;
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function resetData() {
            // First confirmation with detailed warning
            const firstConfirm = confirm('‚ö†Ô∏è PERINGATAN RESET DATA!\n\nYakin ingin mereset SEMUA data presensi?\n\n‚ùå YANG AKAN DIHAPUS:\n‚Ä¢ Semua rekap absensi masuk/pulang\n‚Ä¢ Seluruh riwayat kehadiran\n‚Ä¢ Semua data presensi (hari ini & sebelumnya)\n‚Ä¢ Statistik dashboard\n‚Ä¢ Log aktivitas terbaru\n\n‚úÖ YANG TETAP AMAN:\n‚Ä¢ Data 59 anggota Mahesa Scout\n‚Ä¢ QR Code anggota\n‚Ä¢ Pengaturan sistem\n\nSetelah reset, semua statistik akan kembali ke 0.\n\nLANJUTKAN RESET?');
            
            if (!firstConfirm) {
                console.log('‚ùå Reset dibatalkan oleh user');
                return;
            }
            
            // Second confirmation for safety
            const secondConfirm = confirm('üö® KONFIRMASI TERAKHIR!\n\nAnda akan menghapus SEMUA data presensi yang ada.\nTindakan ini TIDAK DAPAT DIBATALKAN!\n\nKetik OK untuk melanjutkan reset data.');
            
            if (!secondConfirm) {
                console.log('‚ùå Reset dibatalkan pada konfirmasi kedua');
                return;
            }
            
            try {
                console.log('üîÑ Memulai proses reset data...');
                
                const resetTime = new Date().toLocaleString('id-ID');
                const totalDataBefore = attendanceData.length;
                
                // Step 1: HAPUS SEMUA DATA PRESENSI
                console.log(`üóëÔ∏è Menghapus ${totalDataBefore} data presensi...`);
                attendanceData.length = 0; // Clear array completely
                
                // Step 2: RESET DASHBOARD STATISTICS
                console.log('üìä Mereset statistik dashboard...');
                try {
                    document.getElementById('checkedIn').textContent = '0';
                    document.getElementById('checkedOut').textContent = '0';
                    document.getElementById('notCheckedOut').textContent = '0';
                    document.getElementById('attendancePercentage').textContent = '0%';
                } catch (e) {
                    console.log('‚ö†Ô∏è Error updating dashboard elements:', e);
                }
                
                // Step 3: RESET RECENT ACTIVITY
                console.log('üßπ Membersihkan aktivitas terbaru...');
                try {
                    const recentActivityDiv = document.getElementById('recentActivity');
                    if (recentActivityDiv) {
                        recentActivityDiv.innerHTML = '<div class="text-gray-500 text-center py-4">Belum ada aktivitas presensi hari ini</div>';
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Error clearing recent activity:', e);
                }
                
                // Step 4: RESET ATTENDANCE TABLE
                console.log('üìã Mengosongkan tabel presensi...');
                try {
                    const attendanceTableBody = document.getElementById('attendanceTableBody');
                    if (attendanceTableBody) {
                        attendanceTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data presensi hari ini</td></tr>';
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Error clearing attendance table:', e);
                }
                
                // Step 5: FORCE UPDATE ALL DISPLAYS
                console.log('üîÑ Memperbarui semua tampilan...');
                try {
                    updateDashboard();
                    renderAttendanceTable();
                    initializeRecentActivity();
                } catch (e) {
                    console.log('‚ö†Ô∏è Error updating displays:', e);
                }
                
                // Step 6: SUCCESS CONFIRMATION
                console.log('‚úÖ Reset data berhasil!');
                
                const successMessage = `üîÑ RESET DATA BERHASIL DILAKUKAN!\n\n‚è∞ Waktu Reset: ${resetTime}\nüóëÔ∏è Data Terhapus: ${totalDataBefore} rekam presensi\nüë• Data Anggota: ${members.length} (tetap aman)\nüìä Statistik: Semua kembali ke 0\n\n‚úÖ Sistem siap untuk presensi baru!\nüì± Scanner QR tetap berfungsi normal.\n\nüéØ Status: RESET BERHASIL SEMPURNA!`;
                
                alert(successMessage);
                
                // Step 7: LOG RESET ACTIVITY
                console.log(`üîÑ RESET LENGKAP: ${totalDataBefore} data presensi dihapus pada ${resetTime}`);
                console.log('üìä Dashboard direset ke statistik awal');
                console.log('üóëÔ∏è Semua riwayat aktivitas dibersihkan');
                console.log('‚úÖ Reset data selesai dengan sukses');
                
                // Step 8: ADD RESET LOG TO NEW ACTIVITY
                setTimeout(() => {
                    try {
                        addRecentActivity(`üîÑ SISTEM DIRESET - Semua data presensi dihapus (${new Date().toLocaleTimeString('id-ID')})`);
                        console.log('üìù Log reset ditambahkan ke aktivitas');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Error adding reset log:', e);
                    }
                }, 1000);
                
                // Step 9: Show success notification
                setTimeout(() => {
                    showCornerNotification('üîÑ Reset data berhasil! Sistem siap digunakan');
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error during reset process:', error);
                alert(`‚ùå GAGAL RESET DATA!\n\nError: ${error.message}\n\nSolusi:\n‚Ä¢ Refresh halaman (F5)\n‚Ä¢ Coba lagi\n‚Ä¢ Hubungi admin jika masalah berlanjut`);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97d34531c7b5e9cd',t:'MTc1NzU1Mjg2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
